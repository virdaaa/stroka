<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—Ç—Ä–æ–∫–∞ ‚Äî –ö–∞–±–∏–Ω–µ—Ç –∞–≤—Ç–æ—Ä–∞</title>
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b; --bg-secondary: #111113; --bg-card: #161618; --bg-input: #1a1a1c;
            --text-primary: #e8e6e3; --text-secondary: #8a8a8a; --text-muted: #5a5a5a;
            --accent: #c9a55c; --accent-dim: #8a7340; --border: #2a2a2c;
            --danger: #c44; --success: #4a8; --warning: #f0a030;
            --font-display: 'Cormorant Garamond', serif; --font-ui: 'IBM Plex Sans', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-ui); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .logo { font-family: var(--font-display); font-size: 24px; font-weight: 600; text-decoration: none; color: var(--text-primary); }
        .logo span { color: var(--accent); }
        .header-subtitle { font-size: 12px; color: var(--text-muted); }
        .screen { display: none; flex: 1; padding: 20px; }
        .screen.active { display: block; }
        .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .auth-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-secondary); margin-bottom: 32px; }
        .form-group { margin-bottom: 20px; text-align: left; width: 100%; }
        .form-label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .input, .textarea { width: 100%; padding: 14px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: var(--font-ui); font-size: 15px; }
        .input:focus, .textarea:focus { outline: none; border-color: var(--accent); }
        .textarea { min-height: 150px; resize: vertical; }
        .textarea.large { min-height: 300px; }
        .btn { padding: 14px 24px; background: var(--accent); color: var(--bg-primary); border: none; border-radius: 8px; font-family: var(--font-ui); font-size: 15px; font-weight: 500; cursor: pointer; width: 100%; }
        .btn:hover { background: var(--accent-dim); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .dashboard-title { font-family: var(--font-display); font-size: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; }
        .stat-value { font-family: var(--font-display); font-size: 28px; color: var(--accent); }
        .stat-label { font-size: 12px; color: var(--text-muted); }
        .story-item { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .story-item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .story-item-title { font-family: var(--font-display); font-size: 18px; }
        .story-item-status { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: var(--success); color: white; }
        .story-item-status.draft { background: var(--text-muted); }
        .story-item-status.pending { background: var(--warning); color: #000; }
        .story-item-status.rejected { background: var(--danger); }
        .story-item-meta { font-size: 13px; color: var(--text-secondary); }
        .edit-count-badge { font-size: 11px; padding: 2px 6px; border-radius: 4px; background: var(--bg-input); color: var(--text-muted); margin-left: 8px; }
        .edit-count-badge.warning { background: rgba(240, 160, 48, 0.2); color: var(--warning); }
        .edit-count-badge.exhausted { background: rgba(204, 68, 68, 0.2); color: var(--danger); }
        .step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .step-dot.active { background: var(--accent); }
        .step-dot.done { background: var(--success); }
        .step-title { font-family: var(--font-display); font-size: 22px; text-align: center; margin-bottom: 8px; }
        .step-subtitle { text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
        .char-count { text-align: right; font-size: 12px; color: var(--text-muted); margin-top: 8px; }
        .char-count.warning { color: var(--danger); }
        .shorts-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .short-preview { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .short-preview-label { font-size: 12px; color: var(--accent); margin-bottom: 8px; display: block; }
        .short-preview-text { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .genre-display { margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
        .genre-tag { display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; }
        .genre-name { color: var(--text-primary); font-size: 14px; }
        .genre-percent { color: var(--accent); font-size: 12px; font-weight: 500; }
        .tag { padding: 6px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 16px; font-size: 13px; cursor: pointer; }
        .tag.selected { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        .alert { padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .alert-warning { background: rgba(240, 160, 48, 0.15); border: 1px solid var(--warning); }
        .alert-error { background: rgba(204, 68, 68, 0.15); border: 1px solid var(--danger); }
        .alert-info { background: rgba(201, 165, 92, 0.15); border: 1px solid var(--accent); }
        .alert-title { font-weight: 600; margin-bottom: 8px; }
        .alert-warning .alert-title { color: var(--warning); }
        .alert-error .alert-title { color: var(--danger); }
        .alert-info .alert-title { color: var(--accent); }
        .alert-text { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
        .alert-list { margin-top: 12px; padding-left: 20px; }
        .alert-list li { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .literacy-score { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-card); border-radius: 12px; margin-bottom: 20px; }
        .score-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 24px; font-weight: 600; }
        .score-circle.high { background: var(--success); color: white; }
        .score-circle.medium { background: var(--warning); color: #000; }
        .score-circle.low { background: var(--danger); color: white; }
        .checkbox-group { display: flex; align-items: flex-start; gap: 12px; margin: 20px 0; padding: 16px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; margin-top: 2px; accent-color: var(--accent); cursor: pointer; flex-shrink: 0; }
        .checkbox-group label { font-size: 14px; color: var(--text-secondary); line-height: 1.5; cursor: pointer; }
        .checkbox-group label a { color: var(--accent); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: var(--text-secondary); text-align: center; }
        .nav-buttons { display: flex; gap: 12px; margin-top: 24px; }
        .nav-buttons .btn { flex: 1; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 1000; max-width: 480px; margin: 0 auto; }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-muted); font-size: 11px; padding: 4px 16px; }
        .bottom-nav-item:hover { color: var(--text-secondary); }
        .bottom-nav-icon { font-size: 22px; margin-bottom: 2px; }
    </style>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for(var j=0;j<document.scripts.length;j++){if(document.scripts[j].src===r){return;}}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window,document,'script','https://mc.yandex.ru/metrika/tag.js?id=106258778','ym');ym(106258778,'init',{ssr:true,webvisor:true,clickmap:true,ecommerce:"dataLayer",accurateTrackBounce:true,trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106258778" style="position:absolute;left:-9999px;" alt=""/></div></noscript>
<!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="app" style="padding-bottom: 70px;">
        <header class="header">
            <a href="/" class="logo"><div>–°—Ç—Ä–æ<span>–∫–∞</span></div><div class="header-subtitle">–ö–∞–±–∏–Ω–µ—Ç –∞–≤—Ç–æ—Ä–∞</div></a>
            <button class="btn btn-secondary" id="logout-btn" style="width: auto; padding: 8px 16px; display: none;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </header>
        
        <div class="screen active" id="auth-screen">
            <div class="auth-container">
                <div class="auth-title">–í—Ö–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤</div>
                <div class="auth-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</div>
                <div style="margin-bottom: 24px;">
                    <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="stroka_auth_bot" data-size="large" data-radius="8" data-onauth="onTelegramAuth(user)" data-request-access="write"></script>
                </div>
                <div style="color: var(--text-muted); margin-bottom: 24px; font-size: 13px;">–∏–ª–∏</div>
                <form id="auth-form" style="width: 100%; max-width: 300px;">
                    <div class="form-group"><input type="email" class="input" id="auth-email" placeholder="email@example.com" required></div>
                    <button type="submit" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Email</button>
                </form>
            </div>
        </div>
        
        <div class="screen" id="dashboard-screen">
            <div class="dashboard-header">
                <div class="dashboard-title">–ú–æ–∏ —Ä–∞—Å—Å–∫–∞–∑—ã</div>
                <button class="btn" style="width: auto;" onclick="startNewStory()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-stories">0</div><div class="stat-label">–†–∞—Å—Å–∫–∞–∑–æ–≤</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-reads">0</div><div class="stat-label">–ü—Ä–æ—á—Ç–µ–Ω–∏–π</div></div>
            </div>
            <div id="stories-list"></div>
        </div>
        
        <div class="screen" id="add-story-1-screen">
            <div class="step-indicator"><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div></div>
            <div class="step-title" id="step1-title">–ù–æ–≤—ã–π —Ä–∞—Å—Å–∫–∞–∑</div>
            <div class="step-subtitle">–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</div>
            <div id="edit-mode-alert"></div>
            <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="input" id="story-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å–∫–∞–∑–∞" maxlength="100"></div>
            <div class="nav-buttons"><button class="btn btn-secondary" onclick="cancelEdit()">–û—Ç–º–µ–Ω–∞</button><button class="btn" onclick="goToStep2()">–î–∞–ª–µ–µ ‚Üí</button></div>
        </div>
        
        <div class="screen" id="add-story-2-screen">
            <div class="step-indicator"><div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div></div>
            <div class="step-title">–¢–µ–∫—Å—Ç —Ä–∞—Å—Å–∫–∞–∑–∞</div>
            <div class="step-subtitle">–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–æ 60 000 –∑–Ω–∞–∫–æ–≤)</div>
            <div class="form-group"><textarea class="textarea large" id="story-text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å–∫–∞–∑–∞..." oninput="updateCharCount()"></textarea><div class="char-count" id="char-count">0 / 60 000 –∑–Ω–∞–∫–æ–≤</div></div>
            <div class="nav-buttons"><button class="btn btn-secondary" onclick="showScreen('add-story-1')">‚Üê –ù–∞–∑–∞–¥</button><button class="btn" onclick="analyzeStory()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ‚Üí</button></div>
        </div>
        
        <div class="screen" id="add-story-3-screen">
            <div class="step-indicator"><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div></div>
            <div class="step-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="step-subtitle" id="step3-subtitle">–°—Ç—Ä–æ–∫–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞ —Ç–µ–∫—Å—Ç</div>
            <div id="moderation-alert"></div>
            <div id="literacy-section"></div>
            <div id="genre-section" style="display: none;">
                <div class="form-group"><label class="form-label">–ñ–∞–Ω—Ä—ã</label><div class="genre-display" id="genre-display"></div></div>
                <div class="form-group"><label class="form-label">–í–æ–∑—Ä–∞—Å—Ç–Ω–æ–π —Ä–µ–π—Ç–∏–Ω–≥</label><div id="age-rating-display"></div></div>
                <div class="form-group"><label class="form-label">–¢–µ–≥–∏</label><div class="tags-container" id="subgenre-tags"></div></div>
                <div class="form-group"><label class="form-label">–®–æ—Ä—Ç—Å—ã</label><div class="shorts-list" id="shorts-preview"></div></div>
            </div>
            <div id="terms-checkbox-container"></div>
            <div class="nav-buttons"><button class="btn btn-secondary" onclick="showScreen('add-story-2')">‚Üê –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" id="publish-btn" onclick="publishStory()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
        </div>
        
        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item"><span class="bottom-nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
            <a href="/search.html" class="bottom-nav-item"><span class="bottom-nav-icon">üîç</span><span>–ü–æ–∏—Å–∫</span></a>
            <a href="/moe.html" class="bottom-nav-item"><span class="bottom-nav-icon">üìö</span><span>–ú–æ—ë</span></a>
            <a href="/profile.html" class="bottom-nav-item"><span class="bottom-nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
        </nav>
        
        <div class="loading-overlay hidden" id="loading"><div class="spinner"></div><div class="loading-text" id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </div>

    <script>
        var SUPABASE_URL = 'https://xcnvejvkklypvkzkanwj.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbnZlanZra2x5cHZremthbndqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjU4NzIsImV4cCI6MjA4MzY0MTg3Mn0.8ldNxEbzc8aNJYWtOgP0b5lOsPhl4zMeoht2rn0DeP8';
        var AI_WORKER_URL = 'https://ai.stroka.app';
        var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        var MAX_EDITS = 3; // –ú–∞–∫—Å–∏–º—É–º —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π (–≤–∫–ª—é—á–∞—è –ø–µ—Ä–≤—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é)
        var currentAuthor = null;
        var editingStoryId = null;
        var editingStoryEditCount = 0; // –¢–µ–∫—É—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π
        var storyData = { title: '', text: '', genres: [], subgenres: [], shorts: [], similar_to: null, age_rating: '16+', moderation: null, literacy: null };
        var justLoggedOut = false;

        // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è slug
        var TRANSLIT_MAP = {
            '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo', '–∂': 'zh',
            '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o',
            '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts',
            '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya'
        };

        function generateSlug(title) {
            // –°–Ω–∞—á–∞–ª–∞ toLowerCase, –∑–∞—Ç–µ–º Unicode –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ç—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏–∏
            var slug = title.toLowerCase();
            if (slug.normalize) slug = slug.normalize('NFC');
            // –¢—Ä–∞–Ω—Å–ª–∏—Ç–µ—Ä–∞—Ü–∏—è —Ä—É—Å—Å–∫–∏—Ö –±—É–∫–≤
            slug = slug.split('').map(function(char) {
                return TRANSLIT_MAP[char] !== undefined ? TRANSLIT_MAP[char] : char;
            }).join('');
            // –ó–∞–º–µ–Ω—è–µ–º –ø—Ä–æ–±–µ–ª—ã –∏ —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –Ω–∞ –¥–µ—Ñ–∏—Å—ã
            slug = slug.replace(/[^a-z0-9]+/g, '-');
            // –£–±–∏—Ä–∞–µ–º –¥–µ—Ñ–∏—Å—ã –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
            slug = slug.replace(/^-+|-+$/g, '');
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É
            if (slug.length > 60) slug = slug.substring(0, 60).replace(/-+$/, '');
            return slug || 'story';
        }
        
        var urlParams = new URLSearchParams(window.location.search);
        var editId = urlParams.get('edit');
        
        function onTelegramAuth(user) { 
            if (justLoggedOut) { justLoggedOut = false; return; }
            if (currentAuthor) return;
            handleTelegramLogin(user); 
        }
        
        async function handleTelegramLogin(tgUser) {
            showLoading('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...');
            try {
                var email = tgUser.username ? tgUser.username + '@telegram.user' : 'tg_' + tgUser.id + '@telegram.user';
                var name = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || tgUser.username || 'User ' + tgUser.id;
                var { data: existingAuthor } = await db.from('authors').select('*').eq('telegram_id', tgUser.id.toString()).single();
                if (!existingAuthor) { 
                    var { data: byEmail } = await db.from('authors').select('*').eq('email', email).single(); 
                    existingAuthor = byEmail; 
                }
                if (existingAuthor) { 
                    if (!existingAuthor.telegram_id) await db.from('authors').update({ telegram_id: tgUser.id.toString() }).eq('id', existingAuthor.id); 
                    currentAuthor = existingAuthor; 
                } else { 
                    var { data: newAuthor, error } = await db.from('authors').insert({ email: email, name: name, pen_name: tgUser.username || name, telegram_id: tgUser.id.toString() }).select().single(); 
                    if (error) throw error; 
                    currentAuthor = newAuthor; 
                }
                localStorage.setItem('stroka_author', JSON.stringify(currentAuthor));
                localStorage.setItem('stroka_user', JSON.stringify({ id: currentAuthor.id, email: currentAuthor.email }));
                document.getElementById('logout-btn').style.display = 'block';
                hideLoading();
                if (editId) { await loadStoryForEdit(editId); } else { await showDashboard(); }
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        var pendingEmail = null;
        document.getElementById('auth-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            var email = document.getElementById('auth-email').value;
            showLoading('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥...');
            try { 
                var { error } = await db.auth.signInWithOtp({ email: email, options: { shouldCreateUser: true } }); 
                if (error) throw error; 
                pendingEmail = email; hideLoading(); showOtpForm(email); 
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        });
        
        function showOtpForm(email) {
            document.getElementById('auth-form').innerHTML = '<div class="form-group"><p style="color: var(--text-secondary); margin-bottom: 16px;">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞<br><strong style="color: var(--text-primary);">' + email + '</strong></p><input type="text" class="input" id="otp-code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" maxlength="6" style="text-align: center; font-size: 24px;" oninput="this.style.letterSpacing = this.value ? \'8px\' : \'0px\'"></div><button type="button" class="btn" onclick="verifyOtp()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button><button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="resetAuthForm()">–ò–∑–º–µ–Ω–∏—Ç—å email</button>';
        }
        
        async function verifyOtp() {
            var code = document.getElementById('otp-code').value;
            if (!code || code.length < 6) { alert('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥'); return; }
            showLoading('–ü—Ä–æ–≤–µ—Ä—è–µ–º...');
            try { 
                var { error } = await db.auth.verifyOtp({ email: pendingEmail, token: code, type: 'email' }); 
                if (error) throw error; 
                await handleEmailAuthSuccess(pendingEmail); 
            } catch (error) { hideLoading(); alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: ' + error.message); }
        }
        
        async function handleEmailAuthSuccess(email) {
            try {
                var { data: existingAuthor } = await db.from('authors').select('*').eq('email', email).single();
                if (existingAuthor) currentAuthor = existingAuthor;
                else { 
                    var { data: newAuthor, error } = await db.from('authors').insert({ email: email, name: email.split('@')[0], pen_name: email.split('@')[0] }).select().single(); 
                    if (error) throw error; 
                    currentAuthor = newAuthor; 
                }
                localStorage.setItem('stroka_author', JSON.stringify(currentAuthor));
                localStorage.setItem('stroka_user', JSON.stringify({ id: currentAuthor.id, email: currentAuthor.email }));
                document.getElementById('logout-btn').style.display = 'block';
                hideLoading();
                if (editId) { await loadStoryForEdit(editId); } else { await showDashboard(); }
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        function resetAuthForm() { 
            pendingEmail = null; 
            document.getElementById('auth-form').innerHTML = '<div class="form-group"><input type="email" class="input" id="auth-email" placeholder="email@example.com" required></div><button type="submit" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Email</button>'; 
        }
        
        function logout() { 
            justLoggedOut = true;
            currentAuthor = null; editingStoryId = null;
            localStorage.removeItem('stroka_author'); 
            db.auth.signOut(); resetAuthForm(); showScreen('auth'); 
            document.getElementById('logout-btn').style.display = 'none';
            setTimeout(function() { justLoggedOut = false; }, 3000);
        }
        
        function startNewStory() {
            editingStoryId = null;
            editingStoryEditCount = 0;
            storyData = { title: '', text: '', genres: [], subgenres: [], shorts: [], similar_to: null, age_rating: '16+', moderation: null, literacy: null };
            document.getElementById('story-title').value = '';
            document.getElementById('story-text').value = '';
            document.getElementById('step1-title').textContent = '–ù–æ–≤—ã–π —Ä–∞—Å—Å–∫–∞–∑';
            document.getElementById('edit-mode-alert').innerHTML = '';
            document.getElementById('publish-btn').textContent = '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
            updateCharCount();
            showScreen('add-story-1');
        }
        
        function getEditCountBadge(editCount) {
            var remaining = MAX_EDITS - editCount;
            if (remaining <= 0) {
                return '<span class="edit-count-badge exhausted">–ü—Ä–∞–≤–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã</span>';
            } else if (remaining === 1) {
                return '<span class="edit-count-badge warning">–û—Å—Ç–∞–ª–∞—Å—å 1 –ø—Ä–∞–≤–∫–∞</span>';
            } else {
                return '<span class="edit-count-badge">–ü—Ä–∞–≤–æ–∫: ' + remaining + '/' + MAX_EDITS + '</span>';
            }
        }
        
        async function loadStoryForEdit(storyId) {
            showLoading('–ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Å–∫–∞–∑...');
            try {
                var { data: story, error } = await db.from('stories').select('*').eq('id', storyId).eq('author_id', currentAuthor.id).single();
                if (error || !story) {
                    hideLoading();
                    alert('–†–∞—Å—Å–∫–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ —É –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ');
                    await showDashboard(); return;
                }
                
                var editCount = story.edit_count || 0;
                if (editCount >= MAX_EDITS) {
                    hideLoading();
                    alert('–õ–∏–º–∏—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω (' + MAX_EDITS + '/' + MAX_EDITS + '). –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –≤–Ω–µ—Å—Ç–∏ –≤–∞–∂–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É: @stroka_support_bot');
                    await showDashboard(); return;
                }
                
                editingStoryId = storyId;
                editingStoryEditCount = editCount;
                storyData = {
                    title: story.title || '', text: story.full_text || '',
                    genres: story.genres || [], subgenres: story.subgenres || [], shorts: [],
                    similar_to: story.similar_to, age_rating: story.age_rating || '16+', moderation: null, literacy: null
                };

                document.getElementById('story-title').value = storyData.title;
                document.getElementById('story-text').value = storyData.text;
                document.getElementById('step1-title').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ';

                var remaining = MAX_EDITS - editCount - 1; // -1 –∑–∞ —Ç–µ–∫—É—â—É—é –ø—Ä–∞–≤–∫—É
                var remainingText = remaining === 0 ? '–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è!' : '–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –ø—Ä–∞–≤–æ–∫: ' + remaining;
                document.getElementById('edit-mode-alert').innerHTML = '<div class="alert alert-info"><div class="alert-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ ¬´' + story.title + '¬ª</div><div class="alert-text">' + remainingText + '</div></div>';
                document.getElementById('publish-btn').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';

                updateCharCount();
                hideLoading();
                showScreen('add-story-1');
            } catch (error) {
                hideLoading();
                alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
                await showDashboard();
            }
        }
        
        function cancelEdit() {
            editingStoryId = null; editingStoryEditCount = 0;
            if (editId) window.history.replaceState({}, '', '/author.html');
            showScreen('dashboard');
        }
        
        async function showDashboard() {
            showScreen('dashboard');
            document.getElementById('logout-btn').style.display = 'block';
            var { data: stories } = await db.from('stories').select('*').eq('author_id', currentAuthor.id).order('created_at', { ascending: false });
            document.getElementById('stat-stories').textContent = (stories || []).length;
            var list = document.getElementById('stories-list');
            if (!stories || stories.length === 0) { 
                list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–æ–≤.</p>'; 
                return; 
            }
            list.innerHTML = stories.map(function(s) {
                var sc = '', st = '';
                switch(s.status) { 
                    case 'published': sc=''; st='–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'; break; 
                    case 'pending_review': case 'pending': sc='pending'; st='–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'; break; 
                    case 'rejected': sc='rejected'; st='–û—Ç–∫–ª–æ–Ω—ë–Ω'; break; 
                    default: sc='draft'; st='–ß–µ—Ä–Ω–æ–≤–∏–∫'; 
                }
                var safeTitle = s.title.replace(/'/g, "\\'");
                var editCount = s.edit_count || 0;
                var canEdit = editCount < MAX_EDITS;
                var editBtnHtml = canEdit 
                    ? '<button onclick="loadStoryForEdit(\'' + s.id + '\')" style="padding: 8px 12px; background: none; border: 1px solid var(--accent); border-radius: 6px; color: var(--accent); cursor: pointer; font-size: 13px;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>'
                    : '<button disabled style="padding: 8px 12px; background: none; border: 1px solid var(--border); border-radius: 6px; color: var(--text-muted); cursor: not-allowed; font-size: 13px;" title="–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>';
                
                return '<div class="story-item">' +
                    '<div class="story-item-header">' +
                        '<div class="story-item-title">' + s.title + getEditCountBadge(editCount) + '</div>' +
                        '<span class="story-item-status ' + sc + '">' + st + '</span>' +
                    '</div>' +
                    '<div class="story-item-meta">' + (s.character_count ? s.character_count.toLocaleString() : '?') + ' –∑–Ω. ‚Ä¢ ' + (s.reading_time_minutes || '?') + ' –º–∏–Ω</div>' +
                    '<div style="margin-top: 12px; display: flex; gap: 8px;">' +
                        '<a href="/read.html?id=' + s.id + '" style="flex: 1; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); text-decoration: none; text-align: center; font-size: 13px;">–û—Ç–∫—Ä—ã—Ç—å</a>' +
                        editBtnHtml +
                        '<button onclick="deleteStory(\'' + s.id + '\', \'' + safeTitle + '\')" style="padding: 8px 12px; background: none; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); cursor: pointer; font-size: 13px;">–£–¥–∞–ª–∏—Ç—å</button>' +
                    '</div>' +
                '</div>';
            }).join('');
        }
        
        async function deleteStory(storyId, title) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Å–∫–∞–∑ "' + title + '"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
            showLoading('–£–¥–∞–ª—è–µ–º...');
            try {
                await db.from('shorts').delete().eq('story_id', storyId);
                await db.from('moderation_queue').delete().eq('story_id', storyId);
                await db.from('reactions').delete().eq('story_id', storyId);
                await db.from('reading_history').delete().eq('story_id', storyId);
                var { error } = await db.from('stories').delete().eq('id', storyId).eq('author_id', currentAuthor.id);
                if (error) throw error;
                hideLoading(); await showDashboard();
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message); }
        }
        
        function goToStep2() {
            var t = document.getElementById('story-title').value.trim();
            if (!t) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; }
            storyData.title = t;
            showScreen('add-story-2');
        }
        
        function updateCharCount() { 
            var c = document.getElementById('story-text').value.length; 
            var el = document.getElementById('char-count'); 
            el.textContent = c.toLocaleString() + ' / 60 000'; 
            el.classList.toggle('warning', c > 60000); 
        }
        
        async function analyzeStory() {
            var text = document.getElementById('story-text').value.trim();
            if (!text || text.length < 500) { alert('–ú–∏–Ω–∏–º—É–º 500 –∑–Ω–∞–∫–æ–≤'); return; }
            if (text.length > 60000) { alert('–ú–∞–∫—Å–∏–º—É–º 60 000 –∑–Ω–∞–∫–æ–≤'); return; }
            storyData.text = text; 
            storyData.characterCount = text.length; 
            storyData.readingTime = Math.ceil(text.length / 1500);
            showLoading('–°—Ç—Ä–æ–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç...<br>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è');
            try {
                var response = await fetch(AI_WORKER_URL, { 
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ text: text, title: storyData.title }) 
                });
                if (!response.ok) { var err = await response.json(); throw new Error(err.error || '–û—à–∏–±–∫–∞ API'); }
                var result = await response.json();
                if (result.genre && !result.genres) result.genres = [{ name: result.genre, percent: 100 }];
                storyData.genres = result.genres || [];
                storyData.age_rating = result.age_rating || '16+'; 
                storyData.subgenres = result.subgenres || []; 
                storyData.shorts = result.shorts || [];
                storyData.moderation = result.moderation || { status: 'ok', reason: null };
                storyData.literacy = result.literacy || { score: 7, note: '', errors: [], similar_to: null };
                storyData.similar_to = result.literacy?.similar_to || null;
                hideLoading(); showStep3();
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        function showStep3() {
            showScreen('add-story-3');
            var mod = storyData.moderation, lit = storyData.literacy;
            var modDiv = document.getElementById('moderation-alert'), litDiv = document.getElementById('literacy-section');
            var termsDiv = document.getElementById('terms-checkbox-container');
            
            document.getElementById('publish-btn').textContent = editingStoryId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å';
            document.getElementById('publish-btn').disabled = false;
            
            if (mod.status === 'reject') {
                modDiv.innerHTML = '<div class="alert alert-error"><div class="alert-title">‚ùå –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞</div><div class="alert-text"><strong>' + (mod.reason || '–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞') + '</strong><br><br>–ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ: <a href="https://t.me/stroka_support_bot" style="color: var(--accent);">@stroka_support_bot</a></div></div>';
                document.getElementById('publish-btn').style.display = 'none';
                document.getElementById('genre-section').style.display = 'none';
                document.getElementById('step3-subtitle').textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞';
                litDiv.innerHTML = ''; termsDiv.innerHTML = ''; return;
            }
            
            if (mod.status === 'review') {
                modDiv.innerHTML = '<div class="alert alert-warning"><div class="alert-title">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ü–∏—è</div><div class="alert-text">' + (mod.reason || '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.') + '<br><br>–†–∞—Å—Å–∫–∞–∑ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º (–¥–æ 24—á).</div></div>';
                document.getElementById('publish-btn').textContent = editingStoryId ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É';
            } else { modDiv.innerHTML = ''; }
            
            var score = lit.score || 7;
            var scoreClass = score >= 8 ? 'high' : score >= 5 ? 'medium' : 'low';
            
            if (score < 5) {
                var errorsHtml = '';
                if (lit.errors && lit.errors.length) {
                    errorsHtml = '<ul class="alert-list">' + lit.errors.map(function(e) { return '<li>' + e + '</li>'; }).join('') + '</ul>';
                }
                litDiv.innerHTML = '<div class="literacy-score"><div class="score-circle ' + scoreClass + '">' + score + '</div><div class="score-info"><div class="score-label">–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å: —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</div><div class="score-note">' + (lit.note || '') + '</div></div></div>' +
                '<div class="alert alert-warning"><div class="alert-title">‚úèÔ∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç—É—Ä–∞</div><div class="alert-text">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç.</div>' + errorsHtml +
                '<div class="alert-text" style="margin-top:12px;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º: <a href="https://languagetool.org/ru" target="_blank" style="color:var(--accent)">LanguageTool</a>, <a href="https://orfogrammka.ru" target="_blank" style="color:var(--accent)">–û—Ä—Ñ–æ–≥—Ä–∞–º–º–∫–∞</a></div></div>';
                document.getElementById('publish-btn').style.display = 'none';
                document.getElementById('genre-section').style.display = 'none';
                document.getElementById('step3-subtitle').textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞';
                termsDiv.innerHTML = ''; return;
            }
            
            var scoreLabel = score >= 8 ? '–æ—Ç–ª–∏—á–Ω–æ' : score >= 6 ? '—Ö–æ—Ä–æ—à–æ' : '–ø—Ä–∏–µ–º–ª–µ–º–æ';
            litDiv.innerHTML = '<div class="literacy-score"><div class="score-circle ' + scoreClass + '">' + score + '</div><div class="score-info"><div class="score-label">–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å: ' + scoreLabel + '</div><div class="score-note">' + (lit.note || '') + (lit.is_stylized ? ' (—É—á—Ç–µ–Ω–∞ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è)' : '') + '</div></div></div>';
            
            document.getElementById('genre-section').style.display = 'block';
            document.getElementById('publish-btn').style.display = 'block';
            document.getElementById('step3-subtitle').textContent = '–°—Ç—Ä–æ–∫–∞ –ø–æ–¥–æ–±—Ä–∞–ª–∞ —à–æ—Ä—Ç—Å—ã –∏ —Ç–µ–≥–∏';
            
            var genresHtml = '';
            if (storyData.genres && storyData.genres.length > 0) {
                genresHtml = storyData.genres.map(function(g) { return '<span class="genre-tag"><span class="genre-name">' + g.name + '</span><span class="genre-percent">' + g.percent + '%</span></span>'; }).join('');
            } else { genresHtml = '<span class="tag selected">–ü—Ä–æ–∑–∞</span>'; }
            document.getElementById('genre-display').innerHTML = genresHtml;
            
            var ageColors = {'0+': '#4a8', '6+': '#8bc34a', '12+': '#ffc107', '16+': '#ff9800', '18+': '#f44336'};
            var ageColor = ageColors[storyData.age_rating] || ageColors['16+'];
            document.getElementById('age-rating-display').innerHTML = '<span style="display: inline-flex; align-items: center; justify-content: center; min-width: 36px; padding: 4px 8px; background: ' + ageColor + '22; border: 2px solid ' + ageColor + '; border-radius: 6px; color: ' + ageColor + '; font-weight: 600; font-size: 14px;">' + storyData.age_rating + '</span>';
            
            document.getElementById('subgenre-tags').innerHTML = storyData.subgenres.map(function(t) { return '<span class="tag selected">' + t + '</span>'; }).join('');
            document.getElementById('shorts-preview').innerHTML = storyData.shorts.map(function(s, i) { return '<div class="short-preview"><span class="short-preview-label">–®–æ—Ä—Ç—Å ' + (i + 1) + '</span><div class="short-preview-text">' + s + '</div></div>'; }).join('');
            
            // –ß–µ–∫–±–æ–∫—Å —Å–æ–≥–ª–∞—Å–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–≤—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π)
            if (!editingStoryId) {
                termsDiv.innerHTML = '<div class="checkbox-group"><input type="checkbox" id="terms-agree" onchange="updatePublishButton()"><label for="terms-agree">–ü—É–±–ª–∏–∫—É—è –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ, —è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é, —á—Ç–æ —è–≤–ª—è—é—Å—å –µ–≥–æ –∞–≤—Ç–æ—Ä–æ–º, –∏ —Å–æ–≥–ª–∞—à–∞—é—Å—å —Å <a href="/terms.html" target="_blank">–£—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</a> –∏ <a href="/privacy.html" target="_blank">–ü–æ–ª–∏—Ç–∏–∫–æ–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a></label></div>';
                document.getElementById('publish-btn').disabled = true;
            } else {
                termsDiv.innerHTML = '';
            }
        }
        
        function updatePublishButton() {
            var checkbox = document.getElementById('terms-agree');
            document.getElementById('publish-btn').disabled = checkbox ? !checkbox.checked : false;
        }
        
        async function publishStory() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ–∫–±–æ–∫—Å –¥–ª—è –Ω–æ–≤—ã—Ö –ø—É–±–ª–∏–∫–∞—Ü–∏–π
            if (!editingStoryId) {
                var checkbox = document.getElementById('terms-agree');
                if (!checkbox || !checkbox.checked) {
                    alert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è —Å —É—Å–ª–æ–≤–∏—è–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è');
                    return;
                }
            }
            
            var isPending = storyData.moderation?.status === 'review';
            var status = isPending ? 'pending_review' : 'published';
            
            if (editingStoryId) {
                showLoading('–°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è...');
                try {
                    await db.from('shorts').delete().eq('story_id', editingStoryId);
                    
                    var { error } = await db.from('stories').update({
                        title: storyData.title, full_text: storyData.text,
                        genres: storyData.genres, subgenres: storyData.subgenres, similar_to: storyData.similar_to,
                        age_rating: storyData.age_rating, character_count: storyData.characterCount,
                        reading_time_minutes: storyData.readingTime, literacy_score: storyData.literacy?.score,
                        literacy_note: storyData.literacy?.note, status: status,
                        edit_count: editingStoryEditCount + 1,
                        updated_at: new Date().toISOString()
                    }).eq('id', editingStoryId).eq('author_id', currentAuthor.id);
                    
                    if (error) throw error;
                    
                    for (var i = 0; i < storyData.shorts.length; i++) {
                        await db.from('shorts').insert({ story_id: editingStoryId, text: storyData.shorts[i], position: i + 1 });
                    }
                    
                    if (isPending) {
                        await db.from('moderation_queue').delete().eq('story_id', editingStoryId);
                        await db.from('moderation_queue').insert({
                            story_id: editingStoryId, author_id: currentAuthor.id,
                            ai_status: 'review', ai_reason: storyData.moderation?.reason,
                            literacy_score: storyData.literacy?.score, literacy_note: storyData.literacy?.note
                        });
                    }
                    
                    hideLoading();
                    var remaining = MAX_EDITS - editingStoryEditCount - 1;
                    var msg = isPending ? '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é.' : '–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                    if (remaining === 0) msg += '\n\n–í–Ω–∏–º–∞–Ω–∏–µ: –ª–∏–º–∏—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–π –∏—Å—á–µ—Ä–ø–∞–Ω.';
                    else if (remaining === 1) msg += '\n\n–û—Å—Ç–∞–ª–∞—Å—å 1 –ø—Ä–∞–≤–∫–∞.';
                    alert(msg);
                    
                    editingStoryId = null; editingStoryEditCount = 0;
                    storyData = { title: '', text: '', genres: [], subgenres: [], shorts: [], similar_to: null, age_rating: '16+', moderation: null, literacy: null };
                    document.getElementById('story-title').value = '';
                    document.getElementById('story-text').value = '';
                    window.history.replaceState({}, '', '/author.html');
                    showDashboard();
                } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message); }
            } else {
                showLoading(isPending ? '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é...' : '–ü—É–±–ª–∏–∫—É–µ–º...');
                try {
                    var slug = generateSlug(storyData.title);
                    var { data: story, error } = await db.from('stories').insert({
                        author_id: currentAuthor.id, title: storyData.title, slug: slug,
                        full_text: storyData.text, genres: storyData.genres, subgenres: storyData.subgenres,
                        similar_to: storyData.similar_to, age_rating: storyData.age_rating,
                        character_count: storyData.characterCount, reading_time_minutes: storyData.readingTime,
                        literacy_score: storyData.literacy?.score, literacy_note: storyData.literacy?.note,
                        status: status, edit_count: 1,
                        published_at: status === 'published' ? new Date().toISOString() : null
                    }).select().single();
                    
                    if (error) throw error;
                    
                    for (var i = 0; i < storyData.shorts.length; i++) {
                        await db.from('shorts').insert({ story_id: story.id, text: storyData.shorts[i], position: i + 1 });
                    }
                    
                    if (isPending) {
                        await db.from('moderation_queue').insert({
                            story_id: story.id, author_id: currentAuthor.id,
                            ai_status: 'review', ai_reason: storyData.moderation?.reason,
                            literacy_score: storyData.literacy?.score, literacy_note: storyData.literacy?.note
                        });
                    }
                    
                    hideLoading();
                    alert(isPending ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. –£–≤–µ–¥–æ–º–∏–º –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.' : '–†–∞—Å—Å–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!\n\n–£ –≤–∞—Å –æ—Å—Ç–∞–ª–æ—Å—å 2 –ø—Ä–∞–≤–∫–∏ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∑–∞.');
                    storyData = { title: '', text: '', genres: [], subgenres: [], shorts: [], similar_to: null, age_rating: '16+', moderation: null, literacy: null };
                    document.getElementById('story-title').value = '';
                    document.getElementById('story-text').value = '';
                    showDashboard();
                } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
            }
        }
        
        function showScreen(name) { 
            document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); }); 
            document.getElementById(name + '-screen').classList.add('active'); 
        }
        function showLoading(text) { document.getElementById('loading-text').innerHTML = (text || '–ó–∞–≥—Ä—É–∑–∫–∞...').replace(/\n/g, '<br>'); document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        
        var savedAuthor = localStorage.getItem('stroka_author');
        if (savedAuthor) { 
            currentAuthor = JSON.parse(savedAuthor); 
            if (editId) { loadStoryForEdit(editId); } else { showDashboard(); }
        }
    </script>
</body>
</html>
