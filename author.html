<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—Ç—Ä–æ–∫–∞ ‚Äî –ö–∞–±–∏–Ω–µ—Ç –∞–≤—Ç–æ—Ä–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b; --bg-secondary: #111113; --bg-card: #161618; --bg-input: #1a1a1c;
            --text-primary: #e8e6e3; --text-secondary: #8a8a8a; --text-muted: #5a5a5a;
            --accent: #c9a55c; --accent-dim: #8a7340; --border: #2a2a2c;
            --danger: #c44; --success: #4a8; --warning: #f0a030;
            --font-display: 'Cormorant Garamond', serif; --font-ui: 'IBM Plex Sans', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font-ui); background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .app { max-width: 480px; margin: 0 auto; min-height: 100vh; display: flex; flex-direction: column; }
        .header { padding: 16px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .logo { font-family: var(--font-display); font-size: 24px; font-weight: 600; text-decoration: none; color: var(--text-primary); }
        .logo span { color: var(--accent); }
        .header-subtitle { font-size: 12px; color: var(--text-muted); }
        .screen { display: none; flex: 1; padding: 20px; }
        .screen.active { display: block; }
        .auth-container { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 60vh; text-align: center; }
        .auth-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 8px; }
        .auth-subtitle { color: var(--text-secondary); margin-bottom: 32px; }
        .form-group { margin-bottom: 20px; text-align: left; width: 100%; }
        .form-label { display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 8px; }
        .input, .textarea { width: 100%; padding: 14px 16px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-family: var(--font-ui); font-size: 15px; }
        .input:focus, .textarea:focus { outline: none; border-color: var(--accent); }
        .textarea { min-height: 150px; resize: vertical; }
        .textarea.large { min-height: 300px; }
        .btn { padding: 14px 24px; background: var(--accent); color: var(--bg-primary); border: none; border-radius: 8px; font-family: var(--font-ui); font-size: 15px; font-weight: 500; cursor: pointer; width: 100%; }
        .btn:hover { background: var(--accent-dim); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-secondary { background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border); }
        .btn-secondary:hover { border-color: var(--accent); }
        .dashboard-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .dashboard-title { font-family: var(--font-display); font-size: 24px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 24px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 16px; text-align: center; }
        .stat-value { font-family: var(--font-display); font-size: 28px; color: var(--accent); }
        .stat-label { font-size: 12px; color: var(--text-muted); }
        .story-item { background: var(--bg-card); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
        .story-item-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px; }
        .story-item-title { font-family: var(--font-display); font-size: 18px; }
        .story-item-status { font-size: 11px; padding: 4px 8px; border-radius: 4px; background: var(--success); color: white; }
        .story-item-status.draft { background: var(--text-muted); }
        .story-item-status.pending { background: var(--warning); color: #000; }
        .story-item-status.rejected { background: var(--danger); }
        .story-item-meta { font-size: 13px; color: var(--text-secondary); }
        .step-indicator { display: flex; justify-content: center; gap: 8px; margin-bottom: 24px; }
        .step-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .step-dot.active { background: var(--accent); }
        .step-dot.done { background: var(--success); }
        .step-title { font-family: var(--font-display); font-size: 22px; text-align: center; margin-bottom: 8px; }
        .step-subtitle { text-align: center; color: var(--text-secondary); font-size: 14px; margin-bottom: 24px; }
        .char-count { text-align: right; font-size: 12px; color: var(--text-muted); margin-top: 8px; }
        .char-count.warning { color: var(--danger); }
        .shorts-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .short-preview { background: var(--bg-input); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
        .short-preview-label { font-size: 12px; color: var(--accent); margin-bottom: 8px; display: block; }
        .short-preview-text { font-size: 14px; line-height: 1.6; color: var(--text-secondary); }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
        .genre-display { margin-top: 12px; }
        .tag { padding: 6px 12px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 16px; font-size: 13px; cursor: pointer; }
        .tag.selected { background: var(--accent); color: var(--bg-primary); border-color: var(--accent); }
        .alert { padding: 16px; border-radius: 12px; margin-bottom: 20px; }
        .alert-warning { background: rgba(240, 160, 48, 0.15); border: 1px solid var(--warning); }
        .alert-error { background: rgba(204, 68, 68, 0.15); border: 1px solid var(--danger); }
        .alert-title { font-weight: 600; margin-bottom: 8px; }
        .alert-warning .alert-title { color: var(--warning); }
        .alert-error .alert-title { color: var(--danger); }
        .alert-text { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }
        .alert-list { margin-top: 12px; padding-left: 20px; }
        .alert-list li { font-size: 13px; color: var(--text-secondary); margin-bottom: 4px; }
        .literacy-score { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg-card); border-radius: 12px; margin-bottom: 20px; }
        .score-circle { width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 24px; font-weight: 600; }
        .score-circle.high { background: var(--success); color: white; }
        .score-circle.medium { background: var(--warning); color: #000; }
        .score-circle.low { background: var(--danger); color: white; }
        .score-info { flex: 1; }
        .score-label { font-size: 14px; color: var(--text-secondary); }
        .score-note { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .loading-overlay.hidden { display: none; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { margin-top: 16px; color: var(--text-secondary); text-align: center; }
        .nav-buttons { display: flex; gap: 12px; margin-top: 24px; }
        .nav-buttons .btn { flex: 1; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 1000; max-width: 480px; margin: 0 auto; }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-muted); font-size: 11px; padding: 4px 16px; }
        .bottom-nav-item:hover { color: var(--text-secondary); }
        .bottom-nav-icon { font-size: 22px; margin-bottom: 2px; }
    </style>
</head>
<body>
    <div class="app" style="padding-bottom: 70px;">
        <header class="header">
            <a href="/" class="logo"><div>–°—Ç—Ä–æ<span>–∫–∞</span></div><div class="header-subtitle">–ö–∞–±–∏–Ω–µ—Ç –∞–≤—Ç–æ—Ä–∞</div></a>
            <button class="btn btn-secondary" id="logout-btn" style="width: auto; padding: 8px 16px; display: none;" onclick="logout()">–í—ã–π—Ç–∏</button>
        </header>
        
        <div class="screen active" id="auth-screen">
            <div class="auth-container">
                <div class="auth-title">–í—Ö–æ–¥ –¥–ª—è –∞–≤—Ç–æ—Ä–æ–≤</div>
                <div class="auth-subtitle">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞</div>
                <div style="margin-bottom: 24px;">
                    <script async src="https://telegram.org/js/telegram-widget.js?22" data-telegram-login="stroka_auth_bot" data-size="large" data-radius="8" data-onauth="onTelegramAuth(user)" data-request-access="write"></script>
                </div>
                <div style="color: var(--text-muted); margin-bottom: 24px; font-size: 13px;">–∏–ª–∏</div>
                <form id="auth-form" style="width: 100%; max-width: 300px;">
                    <div class="form-group"><input type="email" class="input" id="auth-email" placeholder="email@example.com" required></div>
                    <button type="submit" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Email</button>
                </form>
            </div>
        </div>
        
        <div class="screen" id="dashboard-screen">
            <div class="dashboard-header">
                <div class="dashboard-title">–ú–æ–∏ —Ä–∞—Å—Å–∫–∞–∑—ã</div>
                <button class="btn" style="width: auto;" onclick="showScreen('add-story-1')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div class="stats-grid">
                <div class="stat-card"><div class="stat-value" id="stat-stories">0</div><div class="stat-label">–†–∞—Å—Å–∫–∞–∑–æ–≤</div></div>
                <div class="stat-card"><div class="stat-value" id="stat-reads">0</div><div class="stat-label">–ü—Ä–æ—á—Ç–µ–Ω–∏–π</div></div>
            </div>
            <div id="stories-list"></div>
        </div>
        
        <div class="screen" id="add-story-1-screen">
            <div class="step-indicator"><div class="step-dot active"></div><div class="step-dot"></div><div class="step-dot"></div></div>
            <div class="step-title">–ù–æ–≤—ã–π —Ä–∞—Å—Å–∫–∞–∑</div>
            <div class="step-subtitle">–ù–∞–∑–≤–∞–Ω–∏–µ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="form-group"><label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="input" id="story-title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å–∫–∞–∑–∞"></div>
            <div class="form-group"><label class="form-label">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</label><textarea class="textarea" id="story-description" placeholder="–û —á—ë–º —Ä–∞—Å—Å–∫–∞–∑? 2-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è..."></textarea></div>
            <div class="nav-buttons"><button class="btn btn-secondary" onclick="showScreen('dashboard')">–û—Ç–º–µ–Ω–∞</button><button class="btn" onclick="goToStep2()">–î–∞–ª–µ–µ ‚Üí</button></div>
        </div>
        
        <div class="screen" id="add-story-2-screen">
            <div class="step-indicator"><div class="step-dot done"></div><div class="step-dot active"></div><div class="step-dot"></div></div>
            <div class="step-title">–¢–µ–∫—Å—Ç —Ä–∞—Å—Å–∫–∞–∑–∞</div>
            <div class="step-subtitle">–í—Å—Ç–∞–≤—å—Ç–µ –ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç (–¥–æ 60 000 –∑–Ω–∞–∫–æ–≤)</div>
            <div class="form-group"><textarea class="textarea large" id="story-text" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å–∫–∞–∑–∞..." oninput="updateCharCount()"></textarea><div class="char-count" id="char-count">0 / 60 000 –∑–Ω–∞–∫–æ–≤</div></div>
            <div class="nav-buttons"><button class="btn btn-secondary" onclick="showScreen('add-story-1')">‚Üê –ù–∞–∑–∞–¥</button><button class="btn" onclick="analyzeStory()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å ‚Üí</button></div>
        </div>
        
        <div class="screen" id="add-story-3-screen">
            <div class="step-indicator"><div class="step-dot done"></div><div class="step-dot done"></div><div class="step-dot active"></div></div>
            <div class="step-title">–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏</div>
            <div class="step-subtitle" id="step3-subtitle">–°—Ç—Ä–æ–∫–∞ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∞ —Ç–µ–∫—Å—Ç</div>
            <div id="moderation-alert"></div>
            <div id="literacy-section"></div>
            <div id="genre-section" style="display: none;">
                <div class="form-group"><label class="form-label">–ñ–∞–Ω—Ä</label><div class="genre-display" id="genre-display"></div></div>
                <div class="form-group"><label class="form-label">–¢–µ–≥–∏</label><div class="tags-container" id="subgenre-tags"></div></div>
                <div class="form-group"><label class="form-label">–®–æ—Ä—Ç—Å—ã</label><div class="shorts-list" id="shorts-preview"></div></div>
            </div>
            <div class="nav-buttons"><button class="btn btn-secondary" onclick="showScreen('add-story-2')">‚Üê –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn" id="publish-btn" onclick="publishStory()">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button></div>
        </div>
        
        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item"><span class="bottom-nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
            <a href="/search.html" class="bottom-nav-item"><span class="bottom-nav-icon">üîç</span><span>–ü–æ–∏—Å–∫</span></a>
            <a href="/moe.html" class="bottom-nav-item"><span class="bottom-nav-icon">üìö</span><span>–ú–æ—ë</span></a>
            <a href="/profile.html" class="bottom-nav-item"><span class="bottom-nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
        </nav>
        
        <div class="loading-overlay hidden" id="loading"><div class="spinner"></div><div class="loading-text" id="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xcnvejvkklypvkzkanwj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbnZlanZra2x5cHZremthbndqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjU4NzIsImV4cCI6MjA4MzY0MTg3Mn0.8ldNxEbzc8aNJYWtOgP0b5lOsPhl4zMeoht2rn0DeP8';
        const AI_WORKER_URL = 'https://stroka-ai.spb780.workers.dev';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentAuthor = null;
        let storyData = { title: '', description: '', text: '', genre: '', subgenres: [], shorts: [], moderation: null, literacy: null };
        let justLoggedOut = false;
        
        function onTelegramAuth(user) { 
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ logout
            if (justLoggedOut) {
                justLoggedOut = false;
                return;
            }
            handleTelegramLogin(user); 
        }
        
        async function handleTelegramLogin(tgUser) {
            showLoading('–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...');
            try {
                const email = tgUser.username ? `${tgUser.username}@telegram.user` : `tg_${tgUser.id}@telegram.user`;
                const name = [tgUser.first_name, tgUser.last_name].filter(Boolean).join(' ') || tgUser.username || `User ${tgUser.id}`;
                let { data: existingAuthor } = await db.from('authors').select('*').eq('telegram_id', tgUser.id.toString()).single();
                if (!existingAuthor) { const { data: byEmail } = await db.from('authors').select('*').eq('email', email).single(); existingAuthor = byEmail; }
                if (existingAuthor) { if (!existingAuthor.telegram_id) await db.from('authors').update({ telegram_id: tgUser.id.toString() }).eq('id', existingAuthor.id); currentAuthor = existingAuthor; }
                else { const { data: newAuthor, error } = await db.from('authors').insert({ email, name, pen_name: tgUser.username || name, telegram_id: tgUser.id.toString() }).select().single(); if (error) throw error; currentAuthor = newAuthor; }
                localStorage.setItem('stroka_author', JSON.stringify(currentAuthor));
                document.getElementById('logout-btn').style.display = 'block';
                await showDashboard(); hideLoading();
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        let pendingEmail = null;
        document.getElementById('auth-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            showLoading('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–æ–¥...');
            try { const { error } = await db.auth.signInWithOtp({ email, options: { shouldCreateUser: true } }); if (error) throw error; pendingEmail = email; hideLoading(); showOtpForm(email); }
            catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        });
        
        function showOtpForm(email) {
            document.getElementById('auth-form').innerHTML = `<div class="form-group"><p style="color: var(--text-secondary); margin-bottom: 16px;">–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞<br><strong style="color: var(--text-primary);">${email}</strong></p><input type="text" class="input" id="otp-code" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥" maxlength="6" style="text-align: center; font-size: 24px;" oninput="this.style.letterSpacing = this.value ? '8px' : '0px'"></div><button type="button" class="btn" onclick="verifyOtp()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button><button type="button" class="btn btn-secondary" style="margin-top: 12px;" onclick="resetAuthForm()">–ò–∑–º–µ–Ω–∏—Ç—å email</button>`;
        }
        
        async function verifyOtp() {
            const code = document.getElementById('otp-code').value;
            if (!code || code.length < 6) { alert('–í–≤–µ–¥–∏—Ç–µ 6-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥'); return; }
            showLoading('–ü—Ä–æ–≤–µ—Ä—è–µ–º...');
            try { const { error } = await db.auth.verifyOtp({ email: pendingEmail, token: code, type: 'email' }); if (error) throw error; await handleEmailAuthSuccess(pendingEmail); }
            catch (error) { hideLoading(); alert('–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥: ' + error.message); }
        }
        
        async function handleEmailAuthSuccess(email) {
            try {
                let { data: existingAuthor } = await db.from('authors').select('*').eq('email', email).single();
                if (existingAuthor) currentAuthor = existingAuthor;
                else { const { data: newAuthor, error } = await db.from('authors').insert({ email, name: email.split('@')[0], pen_name: email.split('@')[0] }).select().single(); if (error) throw error; currentAuthor = newAuthor; }
                localStorage.setItem('stroka_author', JSON.stringify(currentAuthor));
                document.getElementById('logout-btn').style.display = 'block';
                await showDashboard(); hideLoading();
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        function resetAuthForm() { pendingEmail = null; document.getElementById('auth-form').innerHTML = `<div class="form-group"><input type="email" class="input" id="auth-email" placeholder="email@example.com" required></div><button type="submit" class="btn">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Email</button>`; }
        function logout() { 
            justLoggedOut = true;
            currentAuthor = null; 
            localStorage.removeItem('stroka_author'); 
            db.auth.signOut(); 
            resetAuthForm(); 
            showScreen('auth'); 
            document.getElementById('logout-btn').style.display = 'none';
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => { justLoggedOut = false; }, 3000);
        }
        
        async function showDashboard() {
            showScreen('dashboard');
            document.getElementById('logout-btn').style.display = 'block';
            const { data: stories } = await db.from('stories').select('*').eq('author_id', currentAuthor.id).order('created_at', { ascending: false });
            document.getElementById('stat-stories').textContent = stories?.length || 0;
            const list = document.getElementById('stories-list');
            if (!stories || stories.length === 0) { list.innerHTML = '<p style="color: var(--text-muted); text-align: center;">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–æ–≤.</p>'; return; }
            list.innerHTML = stories.map(s => {
                let sc = '', st = '';
                switch(s.status) { case 'published': sc=''; st='–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω'; break; case 'pending_review': sc='pending'; st='–ù–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ'; break; case 'rejected': sc='rejected'; st='–û—Ç–∫–ª–æ–Ω—ë–Ω'; break; default: sc='draft'; st='–ß–µ—Ä–Ω–æ–≤–∏–∫'; }
                return `<div class="story-item">
                    <div class="story-item-header">
                        <div class="story-item-title">${s.title}</div>
                        <span class="story-item-status ${sc}">${st}</span>
                    </div>
                    <div class="story-item-meta">${s.character_count?.toLocaleString()||'?'} –∑–Ω. ‚Ä¢ ${s.reading_time_minutes||'?'} –º–∏–Ω</div>
                    <div style="margin-top: 12px; display: flex; gap: 8px;">
                        <a href="/read.html?id=${s.id}" style="flex: 1; padding: 8px; background: var(--bg-input); border: 1px solid var(--border); border-radius: 6px; color: var(--text-secondary); text-decoration: none; text-align: center; font-size: 13px;">–û—Ç–∫—Ä—ã—Ç—å</a>
                        <button onclick="deleteStory('${s.id}', '${s.title.replace(/'/g, "\\'")}')" style="padding: 8px 12px; background: none; border: 1px solid var(--danger); border-radius: 6px; color: var(--danger); cursor: pointer; font-size: 13px;">–£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>`;
            }).join('');
        }
        
        async function deleteStory(storyId, title) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Å–∫–∞–∑ "${title}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) return;
            
            showLoading('–£–¥–∞–ª—è–µ–º...');
            try {
                // –£–¥–∞–ª—è–µ–º —à–æ—Ä—Ç—Å—ã
                await db.from('shorts').delete().eq('story_id', storyId);
                // –£–¥–∞–ª—è–µ–º –∏–∑ –æ—á–µ—Ä–µ–¥–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
                await db.from('moderation_queue').delete().eq('story_id', storyId);
                // –£–¥–∞–ª—è–µ–º —Ä–µ–∞–∫—Ü–∏–∏
                await db.from('reactions').delete().eq('story_id', storyId);
                // –£–¥–∞–ª—è–µ–º —Å–∞–º —Ä–∞—Å—Å–∫–∞–∑
                const { error } = await db.from('stories').delete().eq('id', storyId).eq('author_id', currentAuthor.id);
                if (error) throw error;
                
                hideLoading();
                await showDashboard();
            } catch (error) {
                hideLoading();
                alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + error.message);
            }
        }
        
        function goToStep2() { const t = document.getElementById('story-title').value.trim(); if (!t) { alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ'); return; } storyData.title = t; storyData.description = document.getElementById('story-description').value.trim(); showScreen('add-story-2'); }
        function updateCharCount() { const c = document.getElementById('story-text').value.length; const el = document.getElementById('char-count'); el.textContent = `${c.toLocaleString()} / 60 000`; el.classList.toggle('warning', c > 60000); }
        
        async function analyzeStory() {
            const text = document.getElementById('story-text').value.trim();
            if (!text || text.length < 500) { alert('–ú–∏–Ω–∏–º—É–º 500 –∑–Ω–∞–∫–æ–≤'); return; }
            if (text.length > 60000) { alert('–ú–∞–∫—Å–∏–º—É–º 60 000 –∑–Ω–∞–∫–æ–≤'); return; }
            storyData.text = text; storyData.characterCount = text.length; storyData.readingTime = Math.ceil(text.length / 1500);
            showLoading('–°—Ç—Ä–æ–∫–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç...<br>–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç–∏ –∏ –º–æ–¥–µ—Ä–∞—Ü–∏—è');
            try {
                const response = await fetch(AI_WORKER_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ text, title: storyData.title }) });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error || '–û—à–∏–±–∫–∞ API'); }
                const result = await response.json();
                storyData.genre = result.genre; storyData.subgenres = result.subgenres || []; storyData.shorts = result.shorts || [];
                storyData.moderation = result.moderation || { status: 'ok', reason: null };
                storyData.literacy = result.literacy || { score: 7, note: '', errors: [] };
                hideLoading(); showStep3();
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        function showStep3() {
            showScreen('add-story-3');
            const mod = storyData.moderation, lit = storyData.literacy;
            const modDiv = document.getElementById('moderation-alert'), litDiv = document.getElementById('literacy-section');
            
            if (mod.status === 'reject') {
                modDiv.innerHTML = `<div class="alert alert-error"><div class="alert-title">‚ùå –ü—É–±–ª–∏–∫–∞—Ü–∏—è –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞</div><div class="alert-text"><strong>${mod.reason || '–ö–æ–Ω—Ç–µ–Ω—Ç –Ω–∞—Ä—É—à–∞–µ—Ç –ø—Ä–∞–≤–∏–ª–∞'}</strong><br><br>–ï—Å–ª–∏ —ç—Ç–æ –æ—à–∏–±–∫–∞ ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ: <a href="https://t.me/stroka_support" style="color: var(--accent);">@stroka_support</a></div></div>`;
                document.getElementById('publish-btn').style.display = 'none';
                document.getElementById('genre-section').style.display = 'none';
                document.getElementById('step3-subtitle').textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞';
                litDiv.innerHTML = ''; return;
            }
            
            if (mod.status === 'review') {
                modDiv.innerHTML = `<div class="alert alert-warning"><div class="alert-title">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –º–æ–¥–µ—Ä–∞—Ü–∏—è</div><div class="alert-text">${mod.reason || '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Å–æ–º–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.'}<br><br>–†–∞—Å—Å–∫–∞–∑ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º (–¥–æ 24—á).</div></div>`;
                document.getElementById('publish-btn').textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É';
            } else { modDiv.innerHTML = ''; }
            
            const score = lit.score || 7;
            let scoreClass = score >= 8 ? 'high' : score >= 5 ? 'medium' : 'low';
            
            if (score < 5) {
                litDiv.innerHTML = `<div class="literacy-score"><div class="score-circle ${scoreClass}">${score}</div><div class="score-info"><div class="score-label">–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å: —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏</div><div class="score-note">${lit.note || ''}</div></div></div>
                <div class="alert alert-warning"><div class="alert-title">‚úèÔ∏è –¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–µ–¥–∞–∫—Ç—É—Ä–∞</div><div class="alert-text">–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –º–Ω–æ–≥–æ –æ—à–∏–±–æ–∫. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–µ–∫—Å—Ç.</div>${lit.errors?.length ? `<ul class="alert-list">${lit.errors.map(e => `<li>${e}</li>`).join('')}</ul>` : ''}
                <div class="alert-text" style="margin-top:12px;">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º: <a href="https://languagetool.org/ru" target="_blank" style="color:var(--accent)">LanguageTool</a>, <a href="https://orfogrammka.ru" target="_blank" style="color:var(--accent)">–û—Ä—Ñ–æ–≥—Ä–∞–º–º–∫–∞</a></div></div>`;
                document.getElementById('publish-btn').style.display = 'none';
                document.getElementById('genre-section').style.display = 'none';
                document.getElementById('step3-subtitle').textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Ä–∞–±–æ—Ç–∫–∞';
                return;
            }
            
            litDiv.innerHTML = `<div class="literacy-score"><div class="score-circle ${scoreClass}">${score}</div><div class="score-info"><div class="score-label">–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å: ${score >= 8 ? '–æ—Ç–ª–∏—á–Ω–æ' : score >= 6 ? '—Ö–æ—Ä–æ—à–æ' : '–ø—Ä–∏–µ–º–ª–µ–º–æ'}</div><div class="score-note">${lit.note || ''}${lit.is_stylized ? ' (—É—á—Ç–µ–Ω–∞ —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è)' : ''}</div></div></div>`;
            
            document.getElementById('genre-section').style.display = 'block';
            document.getElementById('publish-btn').style.display = 'block';
            document.getElementById('step3-subtitle').textContent = '–°—Ç—Ä–æ–∫–∞ –ø–æ–¥–æ–±—Ä–∞–ª–∞ —à–æ—Ä—Ç—Å—ã –∏ —Ç–µ–≥–∏';
            
            document.getElementById('genre-display').innerHTML = `<span class="tag selected">${storyData.genre || '–ü—Ä–æ–∑–∞'}</span>`;
            document.getElementById('subgenre-tags').innerHTML = storyData.subgenres.map(t => `<span class="tag selected">${t}</span>`).join('');
            document.getElementById('shorts-preview').innerHTML = storyData.shorts.map((s, i) => `<div class="short-preview"><span class="short-preview-label">–®–æ—Ä—Ç—Å ${i + 1}</span><div class="short-preview-text">${s}</div></div>`).join('');
        }
        
        async function publishStory() {
            const isPending = storyData.moderation?.status === 'review';
            const status = isPending ? 'pending_review' : 'published';
            showLoading(isPending ? '–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é...' : '–ü—É–±–ª–∏–∫—É–µ–º...');
            try {
                const { data: story, error } = await db.from('stories').insert({
                    author_id: currentAuthor.id, title: storyData.title, description: storyData.description,
                    full_text: storyData.text, genre: storyData.genre, subgenres: storyData.subgenres,
                    character_count: storyData.characterCount, reading_time_minutes: storyData.readingTime,
                    literacy_score: storyData.literacy?.score, literacy_note: storyData.literacy?.note,
                    status: status, published_at: status === 'published' ? new Date().toISOString() : null
                }).select().single();
                if (error) throw error;
                
                for (let i = 0; i < storyData.shorts.length; i++) {
                    await db.from('shorts').insert({ story_id: story.id, text: storyData.shorts[i], position: i + 1 });
                }
                
                if (isPending) {
                    await db.from('moderation_queue').insert({
                        story_id: story.id, author_id: currentAuthor.id,
                        ai_status: 'review', ai_reason: storyData.moderation?.reason,
                        literacy_score: storyData.literacy?.score, literacy_note: storyData.literacy?.note
                    });
                }
                
                hideLoading();
                alert(isPending ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –º–æ–¥–µ—Ä–∞—Ü–∏—é. –£–≤–µ–¥–æ–º–∏–º –æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ.' : '–†–∞—Å—Å–∫–∞–∑ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!');
                storyData = { title: '', description: '', text: '', genre: '', subgenres: [], shorts: [], moderation: null, literacy: null };
                document.getElementById('story-title').value = '';
                document.getElementById('story-description').value = '';
                document.getElementById('story-text').value = '';
                showDashboard();
            } catch (error) { hideLoading(); alert('–û—à–∏–±–∫–∞: ' + error.message); }
        }
        
        function showScreen(name) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(name + '-screen').classList.add('active'); }
        function showLoading(text) { document.getElementById('loading-text').innerHTML = (text || '–ó–∞–≥—Ä—É–∑–∫–∞...').replace(/\n/g, '<br>'); document.getElementById('loading').classList.remove('hidden'); }
        function hideLoading() { document.getElementById('loading').classList.add('hidden'); }
        
        const savedAuthor = localStorage.getItem('stroka_author');
        if (savedAuthor) { currentAuthor = JSON.parse(savedAuthor); showDashboard(); }
    </script>
</body>
</html>
