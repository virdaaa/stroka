<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–°—Ç—Ä–æ–∫–∞ ‚Äî –ü–æ–∏—Å–∫</title>
    <link rel="icon" type="image/png" sizes="192x192" href="/icons/icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;600&family=IBM+Plex+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-card: #161618;
            --bg-input: #1a1a1c;
            --text-primary: #e8e6e3;
            --text-secondary: #8a8a8a;
            --text-muted: #5a5a5a;
            --accent: #c9a55c;
            --accent-dim: #8a7340;
            --border: #2a2a2c;
            --font-display: 'Cormorant Garamond', serif;
            --font-ui: 'IBM Plex Sans', sans-serif;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { overflow-x: hidden; }
        body {
            font-family: var(--font-ui);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app {
            max-width: 480px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 70px;
            overflow-x: hidden;
        }
        .result-title, .result-text { word-break: break-word; overflow-wrap: break-word; }
        
        /* Header */
        .header {
            padding: 16px 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-bottom: 1px solid var(--border);
        }
        
        .header-title {
            font-family: var(--font-display);
            font-size: 24px;
            font-weight: 600;
        }
        
        /* Search Box */
        .search-box {
            padding: 16px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        
        .search-input-wrap {
            position: relative;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 16px 14px 44px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-family: var(--font-ui);
            font-size: 15px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .search-input::placeholder {
            color: var(--text-muted);
        }
        
        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: var(--text-muted);
        }
        
        .search-clear {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            font-size: 18px;
            color: var(--text-muted);
            cursor: pointer;
            display: none;
        }
        
        .search-clear.visible {
            display: block;
        }
        
        /* Tabs */
        .search-tabs {
            display: flex;
            padding: 12px 20px;
            gap: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .search-tab {
            padding: 8px 16px;
            background: none;
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-family: var(--font-ui);
            font-size: 14px;
            cursor: pointer;
        }
        
        .search-tab.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        /* Results */
        .results {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .results-count {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 16px;
        }
        
        /* Story Card */
        .story-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: border 0.2s;
            border: 1px solid transparent;
        }
        
        .story-card:hover {
            border-color: var(--accent);
        }
        
        .story-card-title {
            font-family: var(--font-display);
            font-size: 18px;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .story-card-author {
            font-size: 13px;
            color: var(--accent);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .story-card-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: var(--accent);
            color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        
        .story-card-meta {
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .story-card-tags {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            margin-top: 8px;
        }
        
        .story-tag {
            font-size: 11px;
            padding: 3px 8px;
            background: var(--bg-secondary);
            border-radius: 10px;
            color: var(--text-secondary);
        }
        
        .age-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .age-badge.age-0 { background: #4a822; color: #4a8; border: 1px solid #4a8; }
        .age-badge.age-6 { background: #8bc34a22; color: #8bc34a; border: 1px solid #8bc34a; }
        .age-badge.age-12 { background: #ffc10722; color: #ffc107; border: 1px solid #ffc107; }
        .age-badge.age-16 { background: #ff980022; color: #ff9800; border: 1px solid #ff9800; }
        .age-badge.age-18 { background: #f4433622; color: #f44336; border: 1px solid #f44336; }
        
        /* Author Card */
        .author-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .author-card:hover {
            border-color: var(--accent);
        }
        
        .author-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--accent);
            color: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: 600;
            flex-shrink: 0;
            background-size: cover;
            background-position: center;
        }
        
        .author-info {
            flex: 1;
            min-width: 0;
        }
        
        .author-name {
            font-family: var(--font-display);
            font-size: 18px;
            margin-bottom: 4px;
        }
        
        .author-stats {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-muted);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .empty-state-text {
            margin-bottom: 8px;
        }
        
        /* Recent Searches */
        .recent-section {
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .clear-btn {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 12px;
            cursor: pointer;
        }
        
        .recent-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        
        .recent-item:hover {
            color: var(--accent);
        }
        
        .recent-icon {
            font-size: 16px;
            color: var(--text-muted);
        }
        
        /* Popular Tags */
        .popular-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .genre-bubble {
            display: inline-block;
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .genre-bubble:hover {
            border-color: var(--accent);
            transform: scale(1.05);
        }

        .genre-bubble.top {
            font-size: 17px;
            font-weight: 500;
            color: var(--accent);
            border-color: var(--accent-dim);
            padding: 10px 20px;
        }

        .genre-bubble.mid {
            font-size: 14px;
            color: var(--text-primary);
        }

        .genre-bubble.low {
            font-size: 12px;
            color: var(--text-muted);
            padding: 6px 12px;
        }

        .popular-tag {
            padding: 8px 14px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
        }
        
        .popular-tag:hover {
            border-color: var(--accent);
            color: var(--accent);
        }
        
        /* Time Filter */
        .time-filter {
            display: flex;
            gap: 6px;
            margin-bottom: 12px;
            flex-wrap: wrap;
        }
        
        .time-btn {
            padding: 6px 12px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            font-family: var(--font-ui);
        }
        
        .time-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: var(--bg-primary);
        }
        
        .time-btn:hover:not(.active) {
            border-color: var(--text-muted);
            color: var(--text-secondary);
        }
        
        /* Top List */
        .top-list {
            min-height: 60px;
        }
        
        .top-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 8px;
            cursor: pointer;
            border: 1px solid transparent;
        }
        
        .top-item:hover {
            border-color: var(--accent);
        }
        
        .top-rank {
            font-size: 16px;
            font-weight: 600;
            color: var(--accent);
            min-width: 24px;
            text-align: center;
        }
        
        .top-rank.gold { color: #ffd700; }
        .top-rank.silver { color: #c0c0c0; }
        .top-rank.bronze { color: #cd7f32; }
        
        .top-info {
            flex: 1;
            min-width: 0;
        }
        
        .top-title {
            font-family: var(--font-display);
            font-size: 15px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .top-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .top-stat {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .top-skeleton {
            height: 56px;
            background: var(--bg-card);
            border-radius: 10px;
            margin-bottom: 8px;
        }
        
        /* Bottom Navigation */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: 8px 0;
            padding-bottom: max(8px, env(safe-area-inset-bottom));
            z-index: 1000;
            max-width: 480px;
            margin: 0 auto;
        }
        
        .bottom-nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: var(--text-muted);
            font-size: 11px;
            padding: 4px 16px;
        }
        
        .bottom-nav-item:hover { color: var(--text-secondary); }
        .bottom-nav-item.active { color: var(--accent); }
        
        .bottom-nav-icon {
            font-size: 22px;
            margin-bottom: 2px;
        }
        
        /* Skeleton */
        .skeleton {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-secondary) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .skeleton-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .skeleton-title { height: 22px; width: 70%; margin-bottom: 8px; }
        .skeleton-author { height: 14px; width: 40%; margin-bottom: 12px; }
        .skeleton-meta { height: 12px; width: 60%; }
    </style>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){
        m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
        m[i].l=1*new Date();
        for (var j = 0; j < document.scripts.length; j++) {if (document.scripts[j].src === r) { return; }}
        k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)
    })(window, document,'script','https://mc.yandex.ru/metrika/tag.js?id=106258778', 'ym');
    ym(106258778, 'init', {ssr:true, webvisor:true, clickmap:true, ecommerce:"dataLayer", accurateTrackBounce:true, trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106258778" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="header-title">–ü–æ–∏—Å–∫</div>
        </header>
        
        <div class="search-box">
            <div class="search-input-wrap">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="search-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –∞–≤—Ç–æ—Ä –∏–ª–∏ —Ç–µ–≥..." autocomplete="off">
                <button class="search-clear" id="search-clear" onclick="clearSearch()">‚úï</button>
            </div>
        </div>
        
        <div class="search-tabs" id="search-tabs" style="display: none;">
            <button class="search-tab active" data-tab="stories">–†–∞—Å—Å–∫–∞–∑—ã</button>
            <button class="search-tab" data-tab="authors">–ê–≤—Ç–æ—Ä—ã</button>
        </div>
        
        <div class="results" id="results">
            <!-- Initial State -->
            <div id="initial-state">
                <div class="recent-section" id="recent-section" style="display: none;">
                    <div class="section-title">
                        –ù–µ–¥–∞–≤–Ω–∏–µ –ø–æ–∏—Å–∫–∏
                        <button class="clear-btn" onclick="clearRecent()">–û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    <div id="recent-list"></div>
                </div>
                
                <div class="recent-section">
                    <div class="section-title">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ –∂–∞–Ω—Ä—ã</div>
                    <div class="popular-tags" id="genre-bubbles">
                        <!-- –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                    </div>
                </div>
                
                <div class="recent-section">
                    <div class="section-title">üî• –¢–æ–ø –ø–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞–º</div>
                    <div class="time-filter" id="views-filter">
                        <button class="time-btn active" data-period="week" onclick="loadTopViews('week')">–ù–µ–¥–µ–ª—è</button>
                        <button class="time-btn" data-period="month" onclick="loadTopViews('month')">–ú–µ—Å—è—Ü</button>
                        <button class="time-btn" data-period="year" onclick="loadTopViews('year')">–ì–æ–¥</button>
                        <button class="time-btn" data-period="all" onclick="loadTopViews('all')">–í—Å—ë –≤—Ä–µ–º—è</button>
                    </div>
                    <div id="top-views-list" class="top-list"></div>
                </div>
                
                <div class="recent-section">
                    <div class="section-title">üëç –¢–æ–ø –ø–æ —Ä–µ–π—Ç–∏–Ω–≥—É</div>
                    <div class="time-filter" id="likes-filter">
                        <button class="time-btn active" data-period="week" onclick="loadTopLikes('week')">–ù–µ–¥–µ–ª—è</button>
                        <button class="time-btn" data-period="month" onclick="loadTopLikes('month')">–ú–µ—Å—è—Ü</button>
                        <button class="time-btn" data-period="year" onclick="loadTopLikes('year')">–ì–æ–¥</button>
                        <button class="time-btn" data-period="all" onclick="loadTopLikes('all')">–í—Å—ë –≤—Ä–µ–º—è</button>
                    </div>
                    <div id="top-likes-list" class="top-list"></div>
                </div>
            </div>
            
            <!-- Search Results -->
            <div id="search-results" style="display: none;"></div>
        </div>
        
        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item">
                <span class="bottom-nav-icon">üè†</span>
                <span>–ì–ª–∞–≤–Ω–∞—è</span>
            </a>
            <a href="/search.html" class="bottom-nav-item active">
                <span class="bottom-nav-icon">üîç</span>
                <span>–ü–æ–∏—Å–∫</span>
            </a>
            <a href="/moe.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">üìö</span>
                <span>–ú–æ—ë</span>
            </a>
            <a href="/profile.html" class="bottom-nav-item">
                <span class="bottom-nav-icon">üë§</span>
                <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
            </a>
        </nav>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è AbortError ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && event.reason.name === 'AbortError') {
                event.preventDefault();
            }
        });

        const SUPABASE_URL = 'https://xcnvejvkklypvkzkanwj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbnZlanZra2x5cHZremthbndqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjU4NzIsImV4cCI6MjA4MzY0MTg3Mn0.8ldNxEbzc8aNJYWtOgP0b5lOsPhl4zMeoht2rn0DeP8';
        const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const RECENT_KEY = 'stroka_recent_searches';
        let currentTab = 'stories';
        let searchTimeout = null;
        
        // ===== INIT =====
        function init() {
            loadRecentSearches();
            setupEventListeners();

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
            var urlParams = new URLSearchParams(window.location.search);
            var tagParam = urlParams.get('tag');
            var genreParam = urlParams.get('genre');
            var queryParam = urlParams.get('q');
            var authorIdParam = urlParams.get('author_id');

            if (authorIdParam) {
                searchByAuthorId(authorIdParam);
            } else if (tagParam) {
                document.getElementById('search-input').value = '#' + tagParam;
                searchBySubgenre(tagParam);
            } else if (genreParam) {
                document.getElementById('search-input').value = genreParam;
                searchByGenre(genreParam);
            } else if (queryParam) {
                document.getElementById('search-input').value = queryParam;
                performSearch(queryParam);
            } else {
                loadGenreBubbles();
                loadTopViews('week');
                loadTopLikes('week');
            }
        }
        
        // ===== GENRE BUBBLES =====
        async function loadGenreBubbles() {
            const container = document.getElementById('genre-bubbles');
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å–∫–∞–∑—ã —Å –∂–∞–Ω—Ä–∞–º–∏
                const { data: stories } = await db
                    .from('stories')
                    .select('id, genres')
                    .eq('status', 'published');

                if (!stories || stories.length === 0) {
                    container.innerHTML = '<span class="genre-bubble mid" onclick="searchTag(\'–•–æ—Ä—Ä–æ—Ä\')">–•–æ—Ä—Ä–æ—Ä</span><span class="genre-bubble mid" onclick="searchTag(\'–ú–∏—Å—Ç–∏–∫–∞\')">–ú–∏—Å—Ç–∏–∫–∞</span><span class="genre-bubble mid" onclick="searchTag(\'–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞\')">–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</span>';
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–æ—á—Ç–µ–Ω–∏–π –¥–ª—è –≤—Å–µ—Ö —Ä–∞—Å—Å–∫–∞–∑–æ–≤
                const storyIds = stories.map(function(s) { return s.id; });
                const { data: readingHistory } = await db
                    .from('reading_history')
                    .select('story_id')
                    .in('story_id', storyIds);

                // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ—á—Ç–µ–Ω–∏–π –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å—Å–∫–∞–∑–∞
                var readCounts = {};
                (readingHistory || []).forEach(function(r) {
                    readCounts[r.story_id] = (readCounts[r.story_id] || 0) + 1;
                });

                // –°—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã –∂–∞–Ω—Ä–æ–≤: –ø—Ä–æ—á—Ç–µ–Ω–∏–µ √ó –ø—Ä–æ—Ü–µ–Ω—Ç_–∂–∞–Ω—Ä–∞ / 100
                var genreScore = {};
                (stories || []).forEach(function(s) {
                    var reads = readCounts[s.id] || 1; // –º–∏–Ω–∏–º—É–º 1, —á—Ç–æ–±—ã —É—á–∏—Ç—ã–≤–∞—Ç—å –∏ –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ
                    if (s.genres && s.genres.length) {
                        s.genres.forEach(function(g) {
                            var name = g.name || g;
                            var weight = g.weight || 100; // –ø—Ä–æ—Ü–µ–Ω—Ç –∂–∞–Ω—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100%)
                            if (name) {
                                var score = reads * weight / 100;
                                genreScore[name] = (genreScore[name] || 0) + score;
                            }
                        });
                    }
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –±–∞–ª–ª–∞–º –∏ –±–µ—Ä—ë–º —Ç–æ–ø-8
                var sortedGenres = Object.entries(genreScore)
                    .sort(function(a, b) { return b[1] - a[1]; })
                    .slice(0, 8);

                if (sortedGenres.length === 0) {
                    container.innerHTML = '<span class="genre-bubble mid" onclick="searchTag(\'–•–æ—Ä—Ä–æ—Ä\')">–•–æ—Ä—Ä–æ—Ä</span><span class="genre-bubble mid" onclick="searchTag(\'–ú–∏—Å—Ç–∏–∫–∞\')">–ú–∏—Å—Ç–∏–∫–∞</span><span class="genre-bubble mid" onclick="searchTag(\'–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞\')">–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</span>';
                    return;
                }

                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–∞–∑–º–µ—Ä—ã: —Ç–æ–ø-2 –±–æ–ª—å—à–∏–µ, 3-5 —Å—Ä–µ–¥–Ω–∏–µ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–∞–ª–µ–Ω—å–∫–∏–µ
                container.innerHTML = sortedGenres.map(function(item, i) {
                    var genre = item[0];
                    var score = Math.round(item[1]);
                    var sizeClass = i < 2 ? 'top' : i < 5 ? 'mid' : 'low';
                    return '<span class="genre-bubble ' + sizeClass + '" onclick="searchTag(\'' + genre.replace(/'/g, "\\'") + '\')" title="–ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å: ' + score + '">' + genre + '</span>';
                }).join('');

            } catch (e) {
                if (e.name === 'AbortError') return;
                console.error('Genre bubbles error:', e);
                container.innerHTML = '<span class="genre-bubble mid" onclick="searchTag(\'–•–æ—Ä—Ä–æ—Ä\')">–•–æ—Ä—Ä–æ—Ä</span><span class="genre-bubble mid" onclick="searchTag(\'–ú–∏—Å—Ç–∏–∫–∞\')">–ú–∏—Å—Ç–∏–∫–∞</span>';
            }
        }

        // ===== TOP VIEWS =====
        async function loadTopViews(period) {
            // Update active button
            document.querySelectorAll('#views-filter .time-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });
            
            const container = document.getElementById('top-views-list');
            container.innerHTML = '<div class="top-skeleton skeleton"></div><div class="top-skeleton skeleton"></div><div class="top-skeleton skeleton"></div>';
            
            try {
                let query = db
                    .from('stories')
                    .select('id, title, views, genres, genre, reading_time_minutes, published_at')
                    .eq('status', 'published')
                    .order('views', { ascending: false })
                    .limit(5);
                
                // Filter by date
                if (period !== 'all') {
                    const dateFrom = getDateFrom(period);
                    query = query.gte('published_at', dateFrom.toISOString());
                }
                
                const { data: stories, error } = await query;
                
                if (error) throw error;
                
                renderTopList(container, stories || [], 'views');
                
            } catch (e) {
                if (e.name === 'AbortError') return;
                console.error('Top views error:', e);
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        // ===== TOP LIKES =====
        async function loadTopLikes(period) {
            // Update active button
            document.querySelectorAll('#likes-filter .time-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.period === period);
            });

            const container = document.getElementById('top-likes-list');
            container.innerHTML = '<div class="top-skeleton skeleton"></div><div class="top-skeleton skeleton"></div><div class="top-skeleton skeleton"></div>';

            try {
                // Get stories with reactions
                let storiesQuery = db
                    .from('stories')
                    .select('id, title, genres, genre, reading_time_minutes, published_at')
                    .eq('status', 'published');

                if (period !== 'all') {
                    const dateFrom = getDateFrom(period);
                    storiesQuery = storiesQuery.gte('published_at', dateFrom.toISOString());
                }

                const { data: stories, error: storiesError } = await storiesQuery.limit(100);

                console.log('[TopLikes] Period:', period);
                console.log('[TopLikes] Stories found:', stories?.length || 0);
                if (storiesError) console.error('[TopLikes] Stories error:', storiesError);

                if (!stories || stories.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">–ù–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–æ–≤ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
                    return;
                }

                const storyIds = stories.map(s => s.id);

                const { data: reactions, error: reactionsError } = await db
                    .from('reactions')
                    .select('story_id, reaction')
                    .in('story_id', storyIds);

                console.log('[TopLikes] Reactions found:', reactions?.length || 0);
                console.log('[TopLikes] Reactions data:', reactions);
                if (reactionsError) console.error('[TopLikes] Reactions error:', reactionsError);

                // Calculate like percentage
                const statsMap = {};
                storyIds.forEach(id => {
                    statsMap[id] = { likes: 0, dislikes: 0 };
                });

                (reactions || []).forEach(r => {
                    if (statsMap[r.story_id]) {
                        if (r.reaction === 'like') statsMap[r.story_id].likes++;
                        else statsMap[r.story_id].dislikes++;
                    }
                });

                // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ª–∞–π–∫–æ–≤ (–ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã 1 –ª–∞–π–∫)
                const ranked = stories
                    .map(s => {
                        const stats = statsMap[s.id];
                        const total = stats.likes + stats.dislikes;
                        const percent = total > 0 ? Math.round(100 * stats.likes / total) : 0;
                        return { ...s, like_percent: percent, total_votes: total, likes: stats.likes };
                    })
                    .filter(s => s.likes > 0)
                    .sort((a, b) => b.likes - a.likes || b.like_percent - a.like_percent)
                    .slice(0, 5);

                console.log('[TopLikes] Ranked stories with likes:', ranked);

                if (ranked.length === 0) {
                    container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ü–µ–Ω–æ–∫ –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
                    return;
                }

                renderTopList(container, ranked, 'likes');

            } catch (e) {
                if (e.name === 'AbortError') return;
                console.error('Top likes error:', e);
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div>';
            }
        }
        
        function getDateFrom(period) {
            const now = new Date();
            switch (period) {
                case 'week': return new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                case 'month': return new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                case 'year': return new Date(now.getTime() - 365 * 24 * 60 * 60 * 1000);
                default: return new Date(0);
            }
        }
        
        function renderTopList(container, stories, type) {
            if (stories.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted); font-size: 13px;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —ç—Ç–æ—Ç –ø–µ—Ä–∏–æ–¥</div>';
                return;
            }
            
            container.innerHTML = stories.map((s, i) => {
                const rankClass = i === 0 ? 'gold' : i === 1 ? 'silver' : i === 2 ? 'bronze' : '';
                const genreText = s.genres?.length ? s.genres[0].name : (s.genre || '–ü—Ä–æ–∑–∞');
                const statText = type === 'views'
                    ? `üëÅ ${formatNumber(s.views)}`
                    : `üëç ${s.likes}`;
                
                return `
                    <div class="top-item" onclick="openStory('${s.id}')">
                        <div class="top-rank ${rankClass}">${i + 1}</div>
                        <div class="top-info">
                            <div class="top-title">${s.title}</div>
                            <div class="top-meta">${genreText} ¬∑ ${s.reading_time_minutes || '?'} –º–∏–Ω</div>
                        </div>
                        <div class="top-stat">${statText}</div>
                    </div>
                `;
            }).join('');
        }
        
        function formatNumber(num) {
            if (!num) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }
        
        function setupEventListeners() {
            const input = document.getElementById('search-input');
            const clearBtn = document.getElementById('search-clear');
            
            input.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                clearBtn.classList.toggle('visible', query.length > 0);
                
                // Debounce search
                clearTimeout(searchTimeout);
                if (query.length >= 2) {
                    searchTimeout = setTimeout(() => search(query), 300);
                } else if (query.length === 0) {
                    showInitialState();
                }
            });
            
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const query = e.target.value.trim();
                    if (query.length >= 2) {
                        clearTimeout(searchTimeout);
                        search(query);
                        saveRecentSearch(query);
                    }
                }
            });
            
            // Tab switching
            document.querySelectorAll('.search-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentTab = tab.dataset.tab;
                    
                    const query = document.getElementById('search-input').value.trim();
                    if (query.length >= 2) {
                        search(query);
                    }
                });
            });
        }
        
        // ===== SEARCH =====
        async function search(query) {
            document.getElementById('initial-state').style.display = 'none';
            document.getElementById('search-tabs').style.display = 'flex';
            document.getElementById('search-results').style.display = 'block';
            
            // Show skeleton
            document.getElementById('search-results').innerHTML = `
                <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div><div class="skeleton skeleton-meta"></div></div>
                <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div><div class="skeleton skeleton-meta"></div></div>
            `;
            
            if (currentTab === 'stories') {
                await searchStories(query);
            } else {
                await searchAuthors(query);
            }
        }
        
        async function searchStories(query) {
            try {
                const { data: stories, error } = await db
                    .from('stories')
                    .select('id, title, genres, genre, subgenres, age_rating, reading_time_minutes, authors(pen_name, avatar_url)')
                    .eq('status', 'published')
                    .or(`title.ilike.%${query}%,genre.ilike.%${query}%`)
                    .order('published_at', { ascending: false })
                    .limit(30);
                
                if (error) throw error;
                
                // –¢–∞–∫–∂–µ –∏—â–µ–º –ø–æ —Ç–µ–≥–∞–º (subgenres)
                const { data: byTags } = await db
                    .from('stories')
                    .select('id, title, genres, genre, subgenres, age_rating, reading_time_minutes, authors(pen_name, avatar_url)')
                    .eq('status', 'published')
                    .contains('subgenres', [query])
                    .limit(20);
                
                // –û–±—ä–µ–¥–∏–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                const allResults = [...(stories || [])];
                (byTags || []).forEach(s => {
                    if (!allResults.find(r => r.id === s.id)) {
                        allResults.push(s);
                    }
                });
                
                renderStoryResults(allResults, query);
                
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòï</div>
                        <div class="empty-state-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>
                    </div>
                `;
            }
        }

        async function searchAuthors(query) {
            try {
                const { data: authors, error } = await db
                    .from('authors')
                    .select('id, pen_name, name, bio, avatar_url')
                    .or(`pen_name.ilike.%${query}%,name.ilike.%${query}%`)
                    .limit(20);
                
                if (error) throw error;
                
                // –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Å–∫–∞–∑–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–≤—Ç–æ—Ä–∞
                const authorIds = (authors || []).map(a => a.id);
                const { data: storyCounts } = await db
                    .from('stories')
                    .select('author_id')
                    .eq('status', 'published')
                    .in('author_id', authorIds);
                
                const countMap = {};
                (storyCounts || []).forEach(s => {
                    countMap[s.author_id] = (countMap[s.author_id] || 0) + 1;
                });
                
                const authorsWithCounts = (authors || []).map(a => ({
                    ...a,
                    story_count: countMap[a.id] || 0
                })).filter(a => a.story_count > 0); // –¢–æ–ª—å–∫–æ –∞–≤—Ç–æ—Ä—ã —Å —Ä–∞—Å—Å–∫–∞–∑–∞–º–∏
                
                renderAuthorResults(authorsWithCounts, query);
                
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üòï</div>
                        <div class="empty-state-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div>
                    </div>
                `;
            }
        }

        // ===== –ü–û–ò–°–ö –ü–û –¢–ï–ì–£ =====
        async function searchBySubgenre(tag) {
            document.getElementById('initial-state').style.display = 'none';
            document.getElementById('search-tabs').style.display = 'none';
            document.getElementById('search-results').style.display = 'block';
            document.getElementById('search-results').innerHTML = '<div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div></div>'.repeat(3);

            try {
                const { data: stories, error } = await db
                    .from('stories')
                    .select('id, title, genres, genre, subgenres, age_rating, reading_time_minutes, authors(pen_name, avatar_url)')
                    .eq('status', 'published')
                    .contains('subgenres', [tag])
                    .order('published_at', { ascending: false })
                    .limit(50);

                if (error) throw error;
                renderStoryResults(stories || [], '#' + tag);
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><div class="empty-state-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div></div>';
            }
        }

        // ===== –ü–û–ò–°–ö –ü–û –ê–í–¢–û–†–£ (ID) =====
        async function searchByAuthorId(authorId) {
            document.getElementById('initial-state').style.display = 'none';
            document.getElementById('search-tabs').style.display = 'none';
            document.getElementById('search-results').style.display = 'block';
            document.getElementById('search-results').innerHTML = '<div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div></div>'.repeat(3);

            try {
                // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –∏–º—è –∞–≤—Ç–æ—Ä–∞
                const { data: author, error: authorError } = await db
                    .from('authors')
                    .select('pen_name, name')
                    .eq('id', authorId)
                    .single();

                var authorName = author?.pen_name || author?.name || '–ê–≤—Ç–æ—Ä';
                document.getElementById('search-input').value = authorName;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å—Å–∫–∞–∑—ã –∞–≤—Ç–æ—Ä–∞
                const { data: stories, error } = await db
                    .from('stories')
                    .select('id, title, genres, genre, subgenres, age_rating, reading_time_minutes, authors(pen_name, avatar_url)')
                    .eq('status', 'published')
                    .eq('author_id', authorId)
                    .order('published_at', { ascending: false });

                if (error) throw error;

                renderStoryResults(stories || [], authorName);
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error('Author search error:', error);
                document.getElementById('search-results').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><div class="empty-state-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div></div>';
            }
        }

        // ===== –ü–û–ò–°–ö –ü–û –ñ–ê–ù–†–£ =====
        async function searchByGenre(genreName) {
            document.getElementById('initial-state').style.display = 'none';
            document.getElementById('search-tabs').style.display = 'none';
            document.getElementById('search-results').style.display = 'block';
            document.getElementById('search-results').innerHTML = '<div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div></div>'.repeat(3);

            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞—Å—Å–∫–∞–∑—ã –∏ —Ñ–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∂–∞–Ω—Ä—É –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
                const { data: stories, error } = await db
                    .from('stories')
                    .select('id, title, genres, genre, subgenres, age_rating, reading_time_minutes, authors(pen_name, avatar_url)')
                    .eq('status', 'published')
                    .order('published_at', { ascending: false });

                if (error) throw error;

                // –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ –∂–∞–Ω—Ä—É –≤ –º–∞—Å—Å–∏–≤–µ genres
                const filtered = (stories || []).filter(function(s) {
                    if (s.genres && s.genres.length) {
                        return s.genres.some(function(g) { return g.name === genreName; });
                    }
                    return s.genre === genreName;
                });

                renderStoryResults(filtered, genreName);
            } catch (error) {
                if (error.name === 'AbortError') return;
                console.error('Search error:', error);
                document.getElementById('search-results').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><div class="empty-state-text">–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞</div></div>';
            }
        }

        function performSearch(query) {
            search(query);
        }

        // ===== RENDER =====
        function renderStoryResults(stories, query) {
            const container = document.getElementById('search-results');
            
            if (stories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                        <div class="empty-state-subtext" style="font-size: 13px; color: var(--text-muted);">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="results-count">–ù–∞–π–¥–µ–Ω–æ: ${stories.length}</div>
                ${stories.map(s => {
                    const genreText = s.genres?.length
                        ? s.genres.map(g => g.name).join(', ')
                        : (s.genre || '–ü—Ä–æ–∑–∞');
                    const ageRating = s.age_rating || '16+';
                    const authorName = s.authors?.pen_name || '–ê–≤—Ç–æ—Ä';
                    const avatarUrl = s.authors?.avatar_url;
                    const avatarStyle = avatarUrl ? `background-image: url(${avatarUrl})` : '';
                    const avatarContent = avatarUrl ? '' : authorName.charAt(0).toUpperCase();

                    return `
                    <div class="story-card" onclick="openStory('${s.id}')">
                        <div class="story-card-title">
                            ${highlightMatch(s.title, query)}
                            <span class="age-badge age-${ageRating.replace('+', '')}">${ageRating}</span>
                        </div>
                        <div class="story-card-author">
                            <div class="story-card-avatar" style="${avatarStyle}">${avatarContent}</div>
                            <span>${authorName}</span>
                        </div>
                        <div class="story-card-meta">
                            <span>${genreText}</span>
                            <span>‚è± ${s.reading_time_minutes || '?'} –º–∏–Ω</span>
                        </div>
                        ${s.subgenres?.length ? `
                        <div class="story-card-tags">
                            ${s.subgenres.slice(0, 4).map(t => `<span class="story-tag">${t}</span>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                `}).join('')}
            `;
        }
        
        function renderAuthorResults(authors, query) {
            const container = document.getElementById('search-results');
            
            if (authors.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîç</div>
                        <div class="empty-state-text">–ê–≤—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
                        <div class="empty-state-subtext" style="font-size: 13px; color: var(--text-muted);">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = `
                <div class="results-count">–ù–∞–π–¥–µ–Ω–æ: ${authors.length}</div>
                ${authors.map(a => {
                    const avatarStyle = a.avatar_url ? `background-image: url(${a.avatar_url})` : '';
                    const avatarContent = a.avatar_url ? '' : (a.pen_name || a.name || 'A').charAt(0).toUpperCase();
                    return `
                    <div class="author-card" onclick="searchByAuthor('${a.pen_name || a.name}')">
                        <div class="author-avatar" style="${avatarStyle}">${avatarContent}</div>
                        <div class="author-info">
                            <div class="author-name">${highlightMatch(a.pen_name || a.name, query)}</div>
                            <div class="author-stats">${a.story_count} ${pluralize(a.story_count, '—Ä–∞—Å—Å–∫–∞–∑', '—Ä–∞—Å—Å–∫–∞–∑–∞', '—Ä–∞—Å—Å–∫–∞–∑–æ–≤')}</div>
                        </div>
                    </div>
                `}).join('')}
            `;
        }
        
        function highlightMatch(text, query) {
            if (!text || !query) return text;
            const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
            return text.replace(regex, '<span style="color: var(--accent);">$1</span>');
        }
        
        function escapeRegex(str) {
            return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
        
        function pluralize(n, one, few, many) {
            if (n % 10 === 1 && n % 100 !== 11) return one;
            if (n % 10 >= 2 && n % 10 <= 4 && (n % 100 < 10 || n % 100 >= 20)) return few;
            return many;
        }
        
        // ===== ACTIONS =====
        function openStory(storyId) {
            window.location.href = `/read.html?id=${storyId}`;
        }
        
        function searchTag(tag) {
            document.getElementById('search-input').value = tag;
            document.getElementById('search-clear').classList.add('visible');
            search(tag);
            saveRecentSearch(tag);
        }
        
        function searchByAuthor(authorName) {
            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–∞—Å—Å–∫–∞–∑–æ–≤ –∏ –∏—â–µ–º –ø–æ –∞–≤—Ç–æ—Ä—É
            currentTab = 'stories';
            document.querySelectorAll('.search-tab').forEach(t => t.classList.remove('active'));
            document.querySelector('.search-tab[data-tab="stories"]').classList.add('active');
            
            document.getElementById('search-input').value = authorName;
            search(authorName);
        }
        
        function clearSearch() {
            document.getElementById('search-input').value = '';
            document.getElementById('search-clear').classList.remove('visible');
            showInitialState();
        }
        
        function showInitialState() {
            document.getElementById('initial-state').style.display = 'block';
            document.getElementById('search-tabs').style.display = 'none';
            document.getElementById('search-results').style.display = 'none';
        }
        
        // ===== RECENT SEARCHES =====
        function loadRecentSearches() {
            const recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
            
            if (recent.length === 0) {
                document.getElementById('recent-section').style.display = 'none';
                return;
            }
            
            document.getElementById('recent-section').style.display = 'block';
            document.getElementById('recent-list').innerHTML = recent.slice(0, 5).map(q => `
                <div class="recent-item" onclick="searchTag('${q}')">
                    <span class="recent-icon">üïí</span>
                    <span>${q}</span>
                </div>
            `).join('');
        }
        
        function saveRecentSearch(query) {
            let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]');
            recent = recent.filter(q => q.toLowerCase() !== query.toLowerCase());
            recent.unshift(query);
            recent = recent.slice(0, 10);
            localStorage.setItem(RECENT_KEY, JSON.stringify(recent));
        }
        
        function clearRecent() {
            localStorage.removeItem(RECENT_KEY);
            document.getElementById('recent-section').style.display = 'none';
        }
        
        // ===== START =====
        init();
    </script>
</body>
</html>
