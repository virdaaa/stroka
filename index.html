<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/icons/apple-touch-icon.png">
    <meta name="theme-color" content="#c9a55c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>–°—Ç—Ä–æ–∫–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–∞—è –ø—Ä–æ–∑–∞</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;1,400&family=IBM+Plex+Sans:wght@400;500;600&family=Literata:opsz,wght@7..72,400;7..72,500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-primary: #0a0a0b;
            --bg-secondary: #111113;
            --bg-card: #161618;
            --text-primary: #e8e6e3;
            --text-secondary: #8a8a8a;
            --text-muted: #5a5a5a;
            --accent: #c9a55c;
            --accent-dim: #8a7340;
            --border: #2a2a2c;
            --font-display: 'Cormorant Garamond', serif;
            --font-body: 'Literata', serif;
            --font-ui: 'IBM Plex Sans', sans-serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overflow: hidden; overflow-x: hidden; }
        body { font-family: var(--font-ui); background: var(--bg-primary); color: var(--text-primary); overflow-x: hidden; }
        .app { height: 100%; display: flex; flex-direction: column; max-width: 480px; margin: 0 auto; position: relative; padding-bottom: 70px; overflow-x: hidden; }
        .short-card, .short-text, .short-book-title { word-break: break-word; overflow-wrap: break-word; }
        .short-text { max-width: 100%; }
        .header { padding: 16px 20px; display: flex; justify-content: center; align-items: center; background: var(--bg-primary); border-bottom: 1px solid var(--border); z-index: 100; }
        .logo { font-family: var(--font-display); font-size: 28px; font-weight: 600; letter-spacing: 0.05em; }
        .logo span { color: var(--accent); }
        .top-tabs { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: var(--bg-secondary); border-bottom: 1px solid var(--border); overflow-x: visible; overflow-y: visible; -webkit-overflow-scrolling: touch; position: relative; z-index: 100; }
        .top-tabs::-webkit-scrollbar { display: none; }
        .top-tab { padding: 8px 16px; background: none; border: 1px solid var(--border); border-radius: 20px; color: var(--text-secondary); font-family: var(--font-ui); font-size: 14px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .top-tab:hover { border-color: var(--text-muted); }
        .top-tab.active { background: var(--accent); border-color: var(--accent); color: var(--bg-primary); }
        .genre-dropdown { position: relative; }
        .genre-menu { display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 8px 0; min-width: 150px; z-index: 200; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        .genre-menu.open { display: block; }
        .genre-item { padding: 10px 16px; color: var(--text-primary); cursor: pointer; transition: background 0.2s; }
        .genre-item:hover { background: var(--bg-secondary); }
        .genre-item.active { color: var(--accent); }
        .feed { flex: 1; overflow-y: auto; padding: 0; }
        .short-card { padding: 20px; display: flex; flex-direction: column; border-bottom: 1px solid var(--border); cursor: pointer; transition: background 0.2s; }
        .short-card:active { background: var(--bg-secondary); }
        .short-book-info { margin-bottom: 16px; }
        .short-book-title { font-family: var(--font-display); font-size: 24px; font-weight: 600; margin-bottom: 4px; }
        .short-book-author { font-size: 14px; color: var(--text-secondary); margin-bottom: 12px; display: flex; align-items: center; gap: 10px; }
        .author-link { display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 4px 8px 4px 4px; margin: -4px; border-radius: 20px; transition: background 0.2s; }
        .author-link:hover { background: var(--bg-card); }
        .author-avatar-small { width: 28px; height: 28px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 13px; color: var(--bg-primary); font-weight: 600; flex-shrink: 0; }
        .author-name-text { color: var(--text-secondary); transition: color 0.2s; }
        .author-link:hover .author-name-text { color: var(--accent); }
        .author-popup { display: none; position: absolute; top: 100%; left: 0; margin-top: 8px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 16px; min-width: 260px; z-index: 200; box-shadow: 0 8px 24px rgba(0,0,0,0.5); }
        .author-popup.open { display: block; }
        .author-popup-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .author-popup-avatar { width: 48px; height: 48px; border-radius: 50%; background: var(--accent); display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 22px; color: var(--bg-primary); font-weight: 600; }
        .author-popup-name { font-family: var(--font-display); font-size: 18px; color: var(--text-primary); }
        .author-popup-stats { font-size: 12px; color: var(--text-muted); }
        .author-popup-btn { width: 100%; padding: 10px; background: var(--accent); color: var(--bg-primary); border: none; border-radius: 8px; font-family: var(--font-ui); font-size: 13px; font-weight: 500; cursor: pointer; margin-top: 12px; }
        .author-popup-btn:hover { background: var(--accent-dim); }
        .short-meta { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
        .short-meta-item { font-size: 12px; color: var(--text-muted); }
        .short-meta-item.genre { color: var(--accent); font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
        .short-meta-item.genre:hover { opacity: 0.7; text-decoration: underline; }
        .genre-pct { opacity: 0.6; font-weight: 400; font-size: 11px; }
        .short-tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .short-tag { font-size: 11px; padding: 4px 10px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .short-tag:hover { border-color: var(--accent); color: var(--accent); background: rgba(201, 165, 92, 0.1); }
        .short-stats { display: flex; gap: 16px; margin-top: 12px; font-size: 13px; color: var(--text-muted); align-items: center; }
        .short-stat { display: flex; align-items: center; gap: 4px; }
        .short-stat-icon { font-size: 14px; }
        .rating-block { display: flex; align-items: center; gap: 8px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; padding: 6px 12px; position: relative; cursor: pointer; transition: border-color 0.2s; }
        .rating-block:hover { border-color: var(--accent); }
        .rating-thumbs { display: flex; align-items: center; gap: 4px; }
        .rating-thumb { font-size: 18px; }
        .rating-thumb.up { color: #c9a55c; }
        .rating-thumb.down { color: var(--text-muted); opacity: 0.5; }
        .rating-percent { font-size: 16px; font-weight: 600; color: var(--accent); }
        .rating-divider { width: 1px; height: 20px; background: var(--border); }
        .rating-votes { font-size: 11px; color: var(--text-muted); }
        .rating-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; white-space: nowrap; z-index: 100; margin-bottom: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .rating-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--border); }
        .rating-block:hover .rating-tooltip { display: block; }
        .rating-bar { display: flex; height: 8px; border-radius: 4px; overflow: hidden; margin: 8px 0; width: 120px; }
        .rating-bar-like { background: var(--accent); }
        .rating-bar-dislike { background: var(--text-muted); }
        .rating-detail { font-size: 11px; color: var(--text-secondary); display: flex; justify-content: space-between; gap: 16px; }
        .short-stat.views { cursor: pointer; position: relative; transition: color 0.2s; }
        .short-stat.views:hover { color: var(--accent); }
        .views-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; white-space: nowrap; z-index: 100; margin-bottom: 6px; font-size: 11px; color: var(--text-secondary); }
        .views-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 5px solid transparent; border-top-color: var(--border); }
        .short-stat.views:hover .views-tooltip { display: block; }
        .literacy-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .literacy-badge.high { background: rgba(124, 179, 66, 0.15); color: #7cb342; border: 1px solid #7cb342; }
        .literacy-badge.medium { background: rgba(255, 183, 77, 0.15); color: #ffb74d; border: 1px solid #ffb74d; }
        .literacy-badge.low { background: rgba(229, 115, 115, 0.15); color: #e57373; border: 1px solid #e57373; }
        .literacy-meter { position: relative; display: inline-flex; flex-direction: column; align-items: center; cursor: pointer; }
        .literacy-meter svg { width: 48px; height: 32px; }
        .literacy-meter-label { font-size: 8px; color: var(--text-muted); margin-top: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        .literacy-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; white-space: nowrap; z-index: 100; margin-bottom: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
        .literacy-tooltip::after { content: ''; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: var(--border); }
        .literacy-meter:hover .literacy-tooltip, .literacy-meter:active .literacy-tooltip { display: block; }
        .tooltip-title { font-size: 12px; font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .tooltip-score { font-size: 11px; color: var(--text-secondary); }
        .tooltip-score.high { color: #7cb342; }
        .tooltip-score.medium { color: #ffb74d; }
        .tooltip-score.low { color: #e57373; }
        .age-badge { display: inline-flex; align-items: center; justify-content: center; min-width: 28px; padding: 2px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-left: 8px; }
        .age-badge.age-0 { background: #4a822; color: #4a8; border: 1px solid #4a8; }
        .age-badge.age-6 { background: #8bc34a22; color: #8bc34a; border: 1px solid #8bc34a; }
        .age-badge.age-12 { background: #ffc10722; color: #ffc107; border: 1px solid #ffc107; }
        .age-badge.age-16 { background: #ff980022; color: #ff9800; border: 1px solid #ff9800; }
        .age-badge.age-18 { background: #f4433622; color: #f44336; border: 1px solid #f44336; }
        .similar-to { font-size: 12px; color: var(--text-muted); margin-top: 8px; font-style: italic; }
        .short-content { flex: 1; position: relative; margin: 16px 0; }
        .short-text { font-family: var(--font-body); font-size: 16px; line-height: 1.7; color: var(--text-primary); }
        .short-fade { display: none; }
        .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); gap: 16px; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .skeleton-card { padding: 20px; border-bottom: 1px solid var(--border); }
        .skeleton { background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-secondary) 50%, var(--bg-card) 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; border-radius: 4px; }
        .skeleton-title { height: 28px; width: 70%; margin-bottom: 8px; }
        .skeleton-author { height: 16px; width: 40%; margin-bottom: 16px; }
        .skeleton-meta { height: 14px; width: 50%; margin-bottom: 12px; }
        .skeleton-text { height: 80px; width: 100%; }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .load-more { padding: 20px; text-align: center; }
        .load-more-btn { padding: 12px 32px; background: var(--bg-card); border: 1px solid var(--border); border-radius: 8px; color: var(--text-secondary); font-family: var(--font-ui); font-size: 14px; cursor: pointer; }
        .load-more-btn:hover { border-color: var(--accent); color: var(--accent); }
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-muted); text-align: center; padding: 40px; }
        .empty-state-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-state-text { margin-bottom: 8px; }
        .empty-state-subtext { font-size: 13px; color: var(--text-muted); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 8px 0; padding-bottom: max(8px, env(safe-area-inset-bottom)); z-index: 1000; max-width: 480px; margin: 0 auto; }
        .bottom-nav-item { display: flex; flex-direction: column; align-items: center; text-decoration: none; color: var(--text-muted); font-size: 11px; padding: 4px 16px; transition: color 0.2s; }
        .bottom-nav-item:hover { color: var(--text-secondary); }
        .bottom-nav-item.active { color: var(--accent); }
        .bottom-nav-icon { font-size: 22px; margin-bottom: 2px; }
    </style>
<!-- Yandex.Metrika counter -->
<script type="text/javascript">
    (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};m[i].l=1*new Date();for(var j=0;j<document.scripts.length;j++){if(document.scripts[j].src===r){return;}}k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})(window,document,'script','https://mc.yandex.ru/metrika/tag.js?id=106258778','ym');ym(106258778,'init',{ssr:true,webvisor:true,clickmap:true,ecommerce:"dataLayer",accurateTrackBounce:true,trackLinks:true});
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/106258778" style="position:absolute;left:-9999px;" alt=""/></div></noscript>
<!-- /Yandex.Metrika counter -->
</head>
<body>
    <div class="app">
        <header class="header">
            <div class="logo">–°—Ç—Ä–æ<span>–∫–∞</span></div>
        </header>
        
        <div class="top-tabs">
            <button class="top-tab active" data-filter="foryou">–î–ª—è –≤–∞—Å</button>
            <button class="top-tab" data-filter="new">–ù–æ–≤–∏–Ω–∫–∏</button>
            <div class="genre-dropdown">
                <button class="top-tab" id="genre-btn">–ñ–∞–Ω—Ä—ã ‚ñæ</button>
                <div class="genre-menu" id="genre-menu">
                    <div class="genre-item active" data-genre="">–í—Å–µ –∂–∞–Ω—Ä—ã</div>
                    <div class="genre-item" data-genre="–•–æ—Ä—Ä–æ—Ä">–•–æ—Ä—Ä–æ—Ä</div>
                    <div class="genre-item" data-genre="–ú–∏—Å—Ç–∏–∫–∞">–ú–∏—Å—Ç–∏–∫–∞</div>
                    <div class="genre-item" data-genre="–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞">–§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞</div>
                    <div class="genre-item" data-genre="–¢—Ä–∏–ª–ª–µ—Ä">–¢—Ä–∏–ª–ª–µ—Ä</div>
                    <div class="genre-item" data-genre="–î—Ä–∞–º–∞">–î—Ä–∞–º–∞</div>
                    <div class="genre-item" data-genre="–î–µ—Ç–µ–∫—Ç–∏–≤">–î–µ—Ç–µ–∫—Ç–∏–≤</div>
                    <div class="genre-item" data-genre="–§—ç–Ω—Ç–µ–∑–∏">–§—ç–Ω—Ç–µ–∑–∏</div>
                    <div class="genre-item" data-genre="–†–æ–º–∞–Ω—Ç–∏–∫–∞">–†–æ–º–∞–Ω—Ç–∏–∫–∞</div>
                </div>
            </div>
        </div>

        
        <div class="feed" id="feed">
            <div id="skeleton-loader">
                <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div><div class="skeleton skeleton-meta"></div><div class="skeleton skeleton-text"></div></div>
                <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div><div class="skeleton skeleton-meta"></div><div class="skeleton skeleton-text"></div></div>
                <div class="skeleton-card"><div class="skeleton skeleton-title"></div><div class="skeleton skeleton-author"></div><div class="skeleton skeleton-meta"></div><div class="skeleton skeleton-text"></div></div>
            </div>
        </div>
        
        <nav class="bottom-nav">
            <a href="/" class="bottom-nav-item active"><span class="bottom-nav-icon">üè†</span><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
            <a href="/search.html" class="bottom-nav-item"><span class="bottom-nav-icon">üîç</span><span>–ü–æ–∏—Å–∫</span></a>
            <a href="/moe.html" class="bottom-nav-item"><span class="bottom-nav-icon">üìö</span><span>–ú–æ—ë</span></a>
            <a href="/profile.html" class="bottom-nav-item"><span class="bottom-nav-icon">üë§</span><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
        </nav>
    </div>

    <script>
        var SUPABASE_URL = 'https://xcnvejvkklypvkzkanwj.supabase.co';
        var SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhjbnZlanZra2x5cHZremthbndqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNjU4NzIsImV4cCI6MjA4MzY0MTg3Mn0.8ldNxEbzc8aNJYWtOgP0b5lOsPhl4zMeoht2rn0DeP8';
        var db = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        var stories = [];
        var shorts = [];
        var currentFilter = 'foryou';
        var currentGenre = '';
        var currentUser = null;
        var userPreferences = {};
        var readStoryIds = new Set();
        var confirmedAge = 0; // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        
        var ITEMS_PER_PAGE = 10;
        var displayedCount = 0;
        var allShorts = [];
        var CACHE_KEY = 'stroka_feed_cache';
        var CACHE_TTL = 5 * 60 * 1000;
        
        function formatNumber(num) {
            if (!num || num === 0) return '0';
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toString();
        }

        function createLiteracyMeter(score) {
            var litClass = score < 6 ? 'low' : score <= 8 ? 'medium' : 'high';
            var litText = score < 6 ? '–ù–∏–∑–∫–∞—è' : score <= 8 ? '–°—Ä–µ–¥–Ω—è—è' : '–í—ã—Å–æ–∫–∞—è';
            // –£–≥–æ–ª —Å—Ç—Ä–µ–ª–∫–∏: 0 = -90¬∞ (–ª–µ–≤–æ), 10 = 90¬∞ (–ø—Ä–∞–≤–æ), –∫–∞—Ä—Ç–∞ 0-10 –Ω–∞ -90 –¥–æ 90
            var angle = (score / 10) * 180 - 90;
            return '<div class="literacy-meter" onclick="event.stopPropagation()">' +
                '<div class="literacy-tooltip">' +
                    '<div class="tooltip-title">–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å —Ç–µ–∫—Å—Ç–∞</div>' +
                    '<div class="tooltip-score ' + litClass + '">' + litText + ': ' + score + '/10</div>' +
                '</div>' +
                '<svg viewBox="0 0 48 32">' +
                    '<path d="M6 28 A18 18 0 0 1 42 28" fill="none" stroke="#e57373" stroke-width="4" stroke-linecap="round"/>' +
                    '<path d="M6 28 A18 18 0 0 1 14 14" fill="none" stroke="#e57373" stroke-width="4" stroke-linecap="round"/>' +
                    '<path d="M14 14 A18 18 0 0 1 34 14" fill="none" stroke="#ffb74d" stroke-width="4" stroke-linecap="round"/>' +
                    '<path d="M34 14 A18 18 0 0 1 42 28" fill="none" stroke="#7cb342" stroke-width="4" stroke-linecap="round"/>' +
                    '<line x1="24" y1="28" x2="24" y2="14" stroke="var(--text-primary)" stroke-width="2" stroke-linecap="round" transform="rotate(' + angle + ' 24 28)"/>' +
                    '<circle cx="24" cy="28" r="3" fill="var(--text-primary)"/>' +
                '</svg>' +
                '<span class="literacy-meter-label">–ì—Ä–∞–º–æ—Ç–Ω–æ—Å—Ç—å</span>' +
            '</div>';
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–µ–±—É–µ–º—ã–π –≤–æ–∑—Ä–∞—Å—Ç –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞
        function getRequiredAge(rating) {
            switch (rating) {
                case '18+': return 18;
                case '16+': return 16;
                case '12+': return 12;
                default: return 0;
            }
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç
        async function loadConfirmedAge() {
            // –ò–∑ localStorage
            confirmedAge = parseInt(localStorage.getItem('stroka_confirmed_age') || '0');
            
            // –ò–∑ –±–∞–∑—ã (–µ—Å–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω)
            if (currentUser && currentUser.id) {
                try {
                    var { data: author } = await db
                        .from('authors')
                        .select('confirmed_age')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (author && author.confirmed_age) {
                        var dbAge = author.confirmed_age;
                        // –ë–µ—Ä—ë–º –º–∞–∫—Å–∏–º—É–º
                        if (dbAge > confirmedAge) {
                            confirmedAge = dbAge;
                            localStorage.setItem('stroka_confirmed_age', confirmedAge.toString());
                        }
                    }
                } catch (e) {
                    console.error('Error loading confirmed age:', e);
                }
            }
        }
        
        // –§–∏–ª—å—Ç—Ä –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É
        function filterByAge(items) {
            return items.filter(function(item) {
                var requiredAge = getRequiredAge(item.age_rating);
                return confirmedAge >= requiredAge;
            });
        }
        
        async function init() {
            var savedUser = localStorage.getItem('stroka_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
            } else {
                var { data: { user } } = await db.auth.getUser();
                currentUser = user;
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç
            await loadConfirmedAge();
            
            showCachedData();
            
            if (currentUser) {
                await loadUserPreferences();
                await loadReadHistory();
            }
            
            await loadData();
            setupEventListeners();
            setupInfiniteScroll();
        }
        
        function showCachedData() {
            try {
                var cached = localStorage.getItem(CACHE_KEY);
                if (cached) {
                    var parsed = JSON.parse(cached);
                    if (parsed.filter === currentFilter && parsed.genre === currentGenre && Date.now() - parsed.timestamp < CACHE_TTL) {
                        allShorts = parsed.data;
                        displayedCount = 0;
                        renderFeed(true);
                    }
                }
            } catch (e) {
                console.error('Cache error:', e);
            }
        }
        
        function saveToCache() {
            try {
                var cacheData = { data: allShorts, timestamp: Date.now(), filter: currentFilter, genre: currentGenre };
                localStorage.setItem(CACHE_KEY, JSON.stringify(cacheData));
            } catch (e) {
                console.error('Cache save error:', e);
            }
        }
        
        async function loadUserPreferences() {
            try {
                var { data } = await db.from('user_preferences').select('genre, weight').eq('user_id', currentUser.id);
                userPreferences = {};
                (data || []).forEach(function(p) { userPreferences[p.genre] = p.weight; });
            } catch (e) { console.error('Error loading preferences:', e); }
        }
        
        async function loadReadHistory() {
            try {
                var { data } = await db.from('reading_history').select('story_id').eq('user_id', currentUser.id);
                readStoryIds = new Set((data || []).map(function(h) { return h.story_id; }));
            } catch (e) { console.error('Error loading history:', e); }
        }
        
        async function loadData() {
            try {
                var query = db.from('stories').select('*, authors (id, name, pen_name), shorts (id, text, position)').eq('status', 'published');
                if (currentGenre) query = query.eq('genre', currentGenre);
                if (currentFilter === 'new') {
                    query = query.order('published_at', { ascending: false });
                } else {
                    query = query.order('created_at', { ascending: false });
                }
                
                var { data: storiesData, error } = await query;
                if (error) throw error;
                
                stories = storiesData || [];
                var storyIds = stories.map(function(s) { return s.id; });
                
                var { data: reactionsData } = await db.from('reactions').select('story_id, reaction').in('story_id', storyIds);
                
                var statsMap = {};
                stories.forEach(function(s) { statsMap[s.id] = { views: s.views || 0, likes: 0, dislikes: 0 }; });
                (reactionsData || []).forEach(function(r) {
                    if (statsMap[r.story_id]) {
                        if (r.reaction === 'like') statsMap[r.story_id].likes++;
                        else if (r.reaction === 'dislike') statsMap[r.story_id].dislikes++;
                    }
                });
                
                shorts = [];
                stories.forEach(function(story) {
                    var stats = statsMap[story.id] || { views: 0, likes: 0, dislikes: 0 };
                    var totalReactions = stats.likes + stats.dislikes;
                    var likePercent = totalReactions > 0 ? Math.round(100 * stats.likes / totalReactions) : null;
                    
                    if (story.shorts) {
                        story.shorts.forEach(function(short) {
                            shorts.push({
                                id: short.id,
                                text: short.text,
                                position: short.position,
                                story_id: story.id,
                                title: story.title,
                                author: story.authors?.pen_name || story.authors?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∞–≤—Ç–æ—Ä',
                                author_id: story.authors?.id || null,
                                genres: story.genres || [],
                                subgenres: story.subgenres || [],
                                age_rating: story.age_rating || '16+',
                                reading_time: story.reading_time_minutes,
                                character_count: story.character_count,
                                views: stats.views,
                                like_percent: likePercent,
                                total_votes: totalReactions,
                                literacy_score: story.literacy_score,
                                similar_to: story.similar_to,
                                published_at: story.published_at,
                                created_at: story.created_at
                            });
                        });
                    }
                });
                
                if (currentFilter === 'foryou') {
                    shorts = smartSort(shorts);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ —Ä–∞—Å—Å–∫–∞–∑—ã –≤ –ª–µ–Ω—Ç–µ, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑—Ä–∞—Å—Ç–∞ ‚Äî –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
                allShorts = shorts;
                displayedCount = 0;
                saveToCache();
                renderFeed(false);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('feed').innerHTML = '<div class="empty-state"><div class="empty-state-icon">üòï</div><div class="empty-state-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div><div class="empty-state-subtext">' + error.message + '</div><button onclick="loadData()" style="margin-top: 16px; padding: 10px 20px; background: var(--accent); border: none; border-radius: 8px; color: var(--bg-primary); cursor: pointer;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>';
            }
        }
        
        function smartSort(items) {
            var now = Date.now();
            var hour48 = 48 * 60 * 60 * 1000;
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —à–æ—Ä—Ç—Å—ã –ø–æ story_id
            var storyGroups = {};
            items.forEach(function(item) {
                if (!storyGroups[item.story_id]) {
                    storyGroups[item.story_id] = [];
                }
                storyGroups[item.story_id].push(item);
            });
            
            // –ò–∑ –∫–∞–∂–¥–æ–π –≥—Ä—É–ø–ø—ã –±–µ—Ä—ë–º —Å–ª—É—á–∞–π–Ω—ã–π —à–æ—Ä—Ç—Å
            var uniqueItems = Object.keys(storyGroups).map(function(storyId) {
                var group = storyGroups[storyId];
                var randomIndex = Math.floor(Math.random() * group.length);
                return group[randomIndex];
            });
            
            var filtered = uniqueItems;
            if (readStoryIds.size > 0 && uniqueItems.length > 5) {
                var unread = uniqueItems.filter(function(item) { return !readStoryIds.has(item.story_id); });
                if (unread.length >= 3) filtered = unread;
            }
            
            var scored = filtered.map(function(item) {
                var score = Math.random() * 2;
                var storyDate = new Date(item.published_at || item.created_at).getTime();
                if (now - storyDate < hour48) score += 3;
                if (item.genres && item.genres.length > 0) {
                    item.genres.forEach(function(g) {
                        var genreName = g.name || g;
                        var weight = userPreferences[genreName] || 0;
                        score += weight * 0.5;
                    });
                }
                if (item.like_percent && item.like_percent > 70) score += 0.5;
                item.score = score;
                return item;
            });
            
            scored.sort(function(a, b) { return b.score - a.score; });
            
            var result = [];
            var authorCount = {};
            scored.forEach(function(item) {
                var author = item.author;
                var count = authorCount[author] || 0;
                if (count < 2) authorCount[author] = count + 1;
                result.push(item);
            });
            
            return result;
        }
        
        function renderFeed(fromCache) {
            var feed = document.getElementById('feed');
            
            if (allShorts.length === 0) {
                feed.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìñ</div><div class="empty-state-text">–ü–æ–∫–∞ –Ω–µ—Ç —Ä–∞—Å—Å–∫–∞–∑–æ–≤</div><div class="empty-state-subtext">–°—Ç–∞–Ω—å—Ç–µ –ø–µ—Ä–≤—ã–º –∞–≤—Ç–æ—Ä–æ–º!</div><a href="/profile.html" style="margin-top: 16px; padding: 12px 24px; background: var(--accent); color: var(--bg-primary); border-radius: 8px; text-decoration: none; font-weight: 500;">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</a></div>';
                return;
            }
            
            var toShow = allShorts.slice(0, displayedCount + ITEMS_PER_PAGE);
            displayedCount = toShow.length;
            
            var html = toShow.map(function(short) {
                var genresHtml = '';
                if (short.genres && short.genres.length) {
                    genresHtml = short.genres.map(function(g) {
                        return '<span class="short-meta-item genre" onclick="event.stopPropagation(); filterByGenre(\'' + g.name + '\')" title="–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∂–∞–Ω—Ä—É">' + g.name + ' <span class="genre-pct">' + g.percent + '%</span></span>';
                    }).join('');
                } else {
                    genresHtml = '<span class="short-meta-item genre" onclick="event.stopPropagation(); filterByGenre(\'–ü—Ä–æ–∑–∞\')" title="–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –ø–æ –∂–∞–Ω—Ä—É">–ü—Ä–æ–∑–∞</span>';
                }
                
                var tagsHtml = (short.subgenres || []).slice(0, 4).map(function(tag) {
                    return '<span class="short-tag" onclick="event.stopPropagation(); searchByTag(\'' + tag.replace(/'/g, "\\'") + '\')" title="–ò—Å–∫–∞—Ç—å –ø–æ —Ç–µ–≥—É">#' + tag + '</span>';
                }).join('');
                
                var similarHtml = '';
                if (short.similar_to && short.similar_to.length) {
                    similarHtml = '<div class="similar-to">–ï—Å–ª–∏ –Ω—Ä–∞–≤–∏—Ç—Å—è: ' + short.similar_to.join(', ') + '</div>';
                }
                
                var ratingHtml = '';
                if (short.like_percent !== null && short.total_votes > 0) {
                    var likes = Math.round(short.total_votes * short.like_percent / 100);
                    var dislikes = short.total_votes - likes;
                    var dislikePercent = 100 - short.like_percent;
                    ratingHtml = '<div class="rating-block" onclick="event.stopPropagation()">' +
                        '<div class="rating-tooltip">' +
                            '<div style="font-weight: 600; margin-bottom: 4px; color: var(--text-primary);">–û—Ü–µ–Ω–∫–∏ —á–∏—Ç–∞—Ç–µ–ª–µ–π</div>' +
                            '<div class="rating-bar">' +
                                '<div class="rating-bar-like" style="width: ' + short.like_percent + '%"></div>' +
                                '<div class="rating-bar-dislike" style="width: ' + dislikePercent + '%"></div>' +
                            '</div>' +
                            '<div class="rating-detail">' +
                                '<span>üëç ' + likes + ' (' + short.like_percent + '%)</span>' +
                                '<span>üëé ' + dislikes + ' (' + dislikePercent + '%)</span>' +
                            '</div>' +
                        '</div>' +
                        '<div class="rating-thumbs"><span class="rating-thumb up">üëç</span><span class="rating-thumb down">üëé</span></div>' +
                        '<span class="rating-percent">' + short.like_percent + '%</span>' +
                        '<div class="rating-divider"></div>' +
                        '<span class="rating-votes">' + short.total_votes + '</span>' +
                    '</div>';
                }
                
                var literacyHtml = '';
                if (short.literacy_score) {
                    literacyHtml = createLiteracyMeter(short.literacy_score);
                }
                
                var ageClass = 'age-' + (short.age_rating || '16+').replace('+', '');
                
                var authorInitial = (short.author || '–ê')[0].toUpperCase();
                var authorHtml = '<div class="short-book-author">' +
                    '<div class="author-link" onclick="event.stopPropagation(); showAuthorPopup(this, \'' + (short.author_id || '') + '\', \'' + short.author.replace(/'/g, "\\'") + '\')">' +
                        '<div class="author-avatar-small">' + authorInitial + '</div>' +
                        '<span class="author-name-text">' + short.author + '</span>' +
                    '</div>' +
                '</div>';

                return '<div class="short-card" onclick="openStory(\'' + short.story_id + '\')">' +
                    '<div class="short-book-info">' +
                        '<div class="short-book-title">' + short.title + '<span class="age-badge ' + ageClass + '">' + (short.age_rating || '16+') + '</span></div>' +
                        authorHtml +
                        '<div class="short-meta">' + genresHtml + '<span class="short-meta-item">‚è± ' + (short.reading_time || '?') + ' –º–∏–Ω</span></div>' +
                        '<div class="short-tags">' + tagsHtml + '</div>' +
                        similarHtml +
                        '<div class="short-stats">' +
                            '<span class="short-stat views" onclick="event.stopPropagation()"><span class="views-tooltip">–ü—Ä–æ—Å–º–æ—Ç—Ä–æ–≤: ' + (short.views || 0).toLocaleString() + '</span><span class="short-stat-icon">üëÅ</span><span class="short-stat-value">' + formatNumber(short.views) + '</span></span>' +
                            ratingHtml +
                            literacyHtml +
                        '</div>' +
                    '</div>' +
                    '<div class="short-content"><div class="short-text">' + short.text + '</div><div class="short-fade"></div></div>' +
                '</div>';
            }).join('');
            
            if (displayedCount < allShorts.length) {
                html += '<div class="load-more"><button class="load-more-btn" onclick="loadMore()">–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë</button></div>';
            }
            
            feed.innerHTML = html;
        }
        
        function loadMore() { renderFeed(); }
        
        function setupInfiniteScroll() {
            var feed = document.getElementById('feed');
            feed.addEventListener('scroll', function() {
                if (feed.scrollTop + feed.clientHeight >= feed.scrollHeight - 200) {
                    if (displayedCount < allShorts.length) loadMore();
                }
            });
        }
        
        function setupEventListeners() {
            document.querySelectorAll('.top-tab[data-filter]').forEach(function(tab) {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.top-tab[data-filter]').forEach(function(t) { t.classList.remove('active'); });
                    tab.classList.add('active');
                    currentFilter = tab.dataset.filter;
                    loadData();
                });
            });
            
            var genreBtn = document.getElementById('genre-btn');
            var genreMenu = document.getElementById('genre-menu');
            
            genreBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                genreMenu.classList.toggle('open');
            });
            
            document.addEventListener('click', function() { genreMenu.classList.remove('open'); });
            
            document.querySelectorAll('.genre-item').forEach(function(item) {
                item.addEventListener('click', function() {
                    document.querySelectorAll('.genre-item').forEach(function(i) { i.classList.remove('active'); });
                    item.classList.add('active');
                    currentGenre = item.dataset.genre;
                    genreBtn.textContent = currentGenre ? currentGenre + ' ‚ñæ' : '–ñ–∞–Ω—Ä—ã ‚ñæ';
                    if (currentGenre) { genreBtn.classList.add('active'); } else { genreBtn.classList.remove('active'); }
                    genreMenu.classList.remove('open');
                    loadData();
                });
            });
        }
        
        function openStory(storyId) { window.location.href = '/read.html?id=' + storyId; }

        function filterByGenre(genre) {
            currentGenre = genre;
            var genreBtn = document.getElementById('genre-btn');
            genreBtn.textContent = genre + ' ‚ñæ';
            genreBtn.classList.add('active');
            document.querySelectorAll('.genre-item').forEach(function(i) {
                i.classList.remove('active');
                if (i.dataset.genre === genre) i.classList.add('active');
            });
            loadData();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function searchByTag(tag) {
            window.location.href = '/search.html?q=' + encodeURIComponent(tag);
        }

        var currentAuthorPopup = null;

        function showAuthorPopup(element, authorId, authorName) {
            // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π popup
            closeAuthorPopup();

            var initial = authorName[0].toUpperCase();
            var popup = document.createElement('div');
            popup.className = 'author-popup open';
            popup.id = 'author-popup-active';
            popup.innerHTML = '<div class="author-popup-header">' +
                '<div class="author-popup-avatar">' + initial + '</div>' +
                '<div>' +
                    '<div class="author-popup-name">' + authorName + '</div>' +
                    '<div class="author-popup-stats">–ê–≤—Ç–æ—Ä –Ω–∞ –°—Ç—Ä–æ–∫–µ</div>' +
                '</div>' +
            '</div>' +
            '<button class="author-popup-btn" onclick="searchAuthorStories(\'' + authorName.replace(/'/g, "\\'") + '\')">–í—Å–µ –ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞–≤—Ç–æ—Ä–∞</button>';

            element.style.position = 'relative';
            element.appendChild(popup);
            currentAuthorPopup = popup;

            // –ó–∞–∫—Ä—ã—Ç—å –ø—Ä–∏ –∫–ª–∏–∫–µ —Å–Ω–∞—Ä—É–∂–∏
            setTimeout(function() {
                document.addEventListener('click', closeAuthorPopupOnOutside);
            }, 10);
        }

        function closeAuthorPopupOnOutside(e) {
            if (currentAuthorPopup && !currentAuthorPopup.contains(e.target)) {
                closeAuthorPopup();
            }
        }

        function closeAuthorPopup() {
            if (currentAuthorPopup) {
                currentAuthorPopup.remove();
                currentAuthorPopup = null;
                document.removeEventListener('click', closeAuthorPopupOnOutside);
            }
        }

        function searchAuthorStories(authorName) {
            window.location.href = '/search.html?author=' + encodeURIComponent(authorName);
        }
        
        init();
    </script>
</body>
</html>
